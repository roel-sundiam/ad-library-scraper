<div class="dashboard-container">

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Connecting to API...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <mat-icon class="error-icon">error</mat-icon>
          <div>
            <h3>Connection Error</h3>
            <p>{{ error }}</p>
            <p class="error-help">Make sure your Node.js backend server is running on port 3000.</p>
            <button mat-raised-button color="primary" (click)="checkApiHealth()">
              Retry Connection
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Success State -->
  <div *ngIf="apiHealth && !isLoading" class="dashboard-content">
    <!-- Competitor Analysis Hub - Primary Feature -->
    <mat-card class="competitor-analysis-hub">
      <div class="hub-header">
        <div class="hub-background">
          <div class="hub-gradient-overlay"></div>
        </div>
        <div class="hub-content">
          <div class="hub-icon-badge">
            <mat-icon>insights</mat-icon>
          </div>
          <div class="hub-text">
            <h2>Competitor Intelligence</h2>
            <p>Unlock strategic insights from your competitor's Facebook advertising campaigns with AI-powered analysis</p>
          </div>
          <div class="hub-stats">
            <div class="stat-item">
              <span class="stat-number">4-Tier</span>
              <span class="stat-label">Fallback System</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">AI-Powered</span>
              <span class="stat-label">Video Analysis</span>
            </div>
          </div>
        </div>
      </div>
      
      <mat-card-content class="hub-actions">
        <div class="primary-action">
          <button 
            mat-raised-button 
            class="start-analysis-btn"
            routerLink="/competitor-analysis"
            color="primary">
            <div class="btn-content">
              <mat-icon>rocket_launch</mat-icon>
              <span>Start Competitor Analysis</span>
            </div>
          </button>
          
          <p class="action-description">
            <mat-icon>info</mat-icon>
            Analyze Facebook ads from any competitor page URL
          </p>
        </div>
        
        <div class="secondary-actions">
          <button 
            mat-stroked-button 
            class="view-results-btn"
            routerLink="/competitor-analysis/facebook-dashboard"
            *ngIf="hasExistingAnalysis">
            <mat-icon>visibility</mat-icon>
            <span>View Results</span>
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Educational Content - Regular Users -->
    <div *ngIf="!isSuperAdmin" class="educational-content">
      <!-- Getting Started Guide -->
      <mat-card class="guide-card">
        <mat-card-header>
          <div class="guide-icon">
            <mat-icon>school</mat-icon>
          </div>
          <mat-card-title>Getting Started with ScrapeIQ</mat-card-title>
          <mat-card-subtitle>Learn how to analyze your competitors effectively</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="guide-steps">
            <div class="step-item">
              <div class="step-number">1</div>
              <div class="step-content">
                <h4>Find Competitor Pages</h4>
                <p>Identify your competitors' Facebook business pages to analyze their advertising strategies.</p>
              </div>
            </div>
            <div class="step-item">
              <div class="step-number">2</div>
              <div class="step-content">
                <h4>Start Analysis</h4>
                <p>Use the "Start Competitor Analysis" button above to begin scraping and analyzing competitor ads.</p>
              </div>
            </div>
            <div class="step-item">
              <div class="step-number">3</div>
              <div class="step-content">
                <h4>AI-Powered Insights</h4>
                <p>Get detailed insights using our AI analysis tools including video content analysis and strategic recommendations.</p>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Features Overview -->
      <div class="features-grid">
        <mat-card class="feature-card">
          <div class="feature-icon">
            <mat-icon>analytics</mat-icon>
          </div>
          <div class="feature-content">
            <h3>Ad Library Scraping</h3>
            <p>Access Facebook's Ad Library to gather comprehensive competitor advertising data including creative content, targeting insights, and campaign performance metrics.</p>
            <div class="feature-benefits">
              <span class="benefit-tag">Real-time Data</span>
              <span class="benefit-tag">Multiple Formats</span>
            </div>
          </div>
        </mat-card>

        <mat-card class="feature-card">
          <div class="feature-icon">
            <mat-icon>smart_toy</mat-icon>
          </div>
          <div class="feature-content">
            <h3>AI Video Analysis</h3>
            <p>Leverage advanced AI to analyze competitor video advertisements, extract transcripts, and identify key messaging patterns and creative strategies.</p>
            <div class="feature-benefits">
              <span class="benefit-tag">Transcript Analysis</span>
              <span class="benefit-tag">Content Insights</span>
            </div>
          </div>
        </mat-card>

        <mat-card class="feature-card">
          <div class="feature-icon">
            <mat-icon>insights</mat-icon>
          </div>
          <div class="feature-content">
            <h3>Strategic Intelligence</h3>
            <p>Generate actionable insights and strategic recommendations based on competitor analysis to inform your own marketing and advertising decisions.</p>
            <div class="feature-benefits">
              <span class="benefit-tag">Market Trends</span>
              <span class="benefit-tag">Competitive Gaps</span>
            </div>
          </div>
        </mat-card>

        <mat-card class="feature-card">
          <div class="feature-icon">
            <mat-icon>chat</mat-icon>
          </div>
          <div class="feature-content">
            <h3>AI Chat Assistant</h3>
            <p>Interactive AI assistant to help you interpret analysis results, ask follow-up questions, and explore deeper insights from your competitor research.</p>
            <div class="feature-benefits">
              <span class="benefit-tag">Interactive Q&A</span>
              <span class="benefit-tag">Custom Analysis</span>
            </div>
          </div>
        </mat-card>
      </div>

      <!-- Tips and Best Practices -->
      <mat-card class="tips-card">
        <mat-card-header>
          <div class="tips-icon">
            <mat-icon>lightbulb</mat-icon>
          </div>
          <mat-card-title>Pro Tips for Better Analysis</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="tips-grid">
            <div class="tip-item">
              <mat-icon>target</mat-icon>
              <div class="tip-content">
                <h4>Focus on Direct Competitors</h4>
                <p>Analyze businesses that target similar audiences and offer competing products or services for more relevant insights.</p>
              </div>
            </div>
            <div class="tip-item">
              <mat-icon>schedule</mat-icon>
              <div class="tip-content">
                <h4>Regular Monitoring</h4>
                <p>Perform competitor analysis regularly to track changes in their advertising strategies and stay ahead of market trends.</p>
              </div>
            </div>
            <div class="tip-item">
              <mat-icon>psychology</mat-icon>
              <div class="tip-content">
                <h4>Use AI Analysis</h4>
                <p>Take advantage of our AI tools to uncover deeper insights that might not be immediately apparent from surface-level data.</p>
              </div>
            </div>
            <div class="tip-item">
              <mat-icon>download</mat-icon>
              <div class="tip-content">
                <h4>Export Results</h4>
                <p>Download your analysis results and reports to share with your team and incorporate into your marketing strategy planning.</p>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- API Status Card - Super Admin Only -->
    <mat-card class="status-card" *ngIf="isSuperAdmin">
      <mat-card-header>
        <mat-card-title>API Status</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="status-grid">
          <div class="status-item">
            <span class="status-label">Status</span>
            <span class="status-value success">{{ apiHealth.data?.status || 'Unknown' }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">Version</span>
            <span class="status-value">{{ apiHealth.data?.version || 'N/A' }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">Database</span>
            <span class="status-value success">{{ apiHealth.data?.database || 'Unknown' }}</span>
          </div>
          <div class="status-item">
            <span class="status-label">Uptime</span>
            <span class="status-value">{{ apiHealth.data?.uptime || 0 }}s</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Facebook Token Configuration - Super Admin Only -->
    <mat-card class="token-config-card" *ngIf="isSuperAdmin">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>vpn_key</mat-icon>
          Facebook API Configuration
        </mat-card-title>
        <mat-card-subtitle>Configure your Facebook access token for real ads data</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="token-status" *ngIf="tokenStatus">
          <div class="status-indicator" [class]="tokenStatus.hasToken ? 'status-active' : 'status-missing'">
            <mat-icon>{{ tokenStatus.hasToken ? 'check_circle' : 'error' }}</mat-icon>
            <span>{{ tokenStatus.hasToken ? 'Token Active' : 'Token Missing' }}</span>
          </div>
          <div *ngIf="tokenStatus.hasToken" class="token-info">
            <small>{{ tokenStatus.tokenPreview }} ({{ tokenStatus.tokenLength }} chars)</small>
          </div>
        </div>

        <div class="token-actions">
          <button mat-raised-button 
                  color="primary" 
                  (click)="showTokenForm = !showTokenForm"
                  [disabled]="isUpdatingToken">
            <mat-icon>{{ showTokenForm ? 'close' : 'edit' }}</mat-icon>
            {{ showTokenForm ? 'Cancel' : 'Update Token' }}
          </button>
          
          <button mat-stroked-button 
                  (click)="openFacebookConsole()"
                  title="Get a new Facebook access token">
            <mat-icon>open_in_new</mat-icon>
            Get Token
          </button>
        </div>

        <!-- Token Update Form -->
        <div *ngIf="showTokenForm" class="token-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Facebook Access Token</mat-label>
            <textarea matInput 
                      [(ngModel)]="newToken"
                      placeholder="EAA..."
                      rows="3"
                      (keyup.enter)="updateFacebookToken()"></textarea>
            <mat-hint>Paste your Facebook access token here</mat-hint>
          </mat-form-field>
          
          <div class="form-actions">
            <button mat-raised-button 
                    color="primary" 
                    (click)="updateFacebookToken()"
                    [disabled]="!newToken || isUpdatingToken">
              <mat-spinner *ngIf="isUpdatingToken" diameter="20"></mat-spinner>
              <mat-icon *ngIf="!isUpdatingToken">save</mat-icon>
              {{ isUpdatingToken ? 'Updating...' : 'Save Token' }}
            </button>
          </div>
        </div>

        <!-- Messages -->
        <div *ngIf="tokenMessage" class="token-message" [class]="tokenMessage.type">
          <mat-icon>{{ 
            tokenMessage.type === 'success' ? 'check_circle' : 
            tokenMessage.type === 'warning' ? 'warning' : 'error' 
          }}</mat-icon>
          <span>{{ tokenMessage.text }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Test Video Transcription - Super Admin Only -->
    <mat-card class="test-transcription-card" *ngIf="isSuperAdmin">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>play_arrow</mat-icon>
          Test Video Transcription
        </mat-card-title>
        <mat-card-subtitle>Test the video transcription service with any video URL</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="test-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Video URL</mat-label>
            <input matInput [(ngModel)]="testVideoUrl" placeholder="https://example.com/video.mp4">
            <mat-icon matSuffix>link</mat-icon>
          </mat-form-field>
          
          <div class="form-actions">
            <button mat-raised-button color="primary" 
                    (click)="testVideoTranscription()" 
                    [disabled]="!testVideoUrl || testingVideo"
                    class="test-btn">
              <mat-icon *ngIf="!testingVideo">play_arrow</mat-icon>
              <mat-spinner *ngIf="testingVideo" diameter="20"></mat-spinner>
              {{ testingVideo ? 'Testing...' : 'Test Transcription' }}
            </button>
          </div>
        </div>

        <!-- Test Result -->
        <div *ngIf="testResult" class="test-result">
          <div class="result-header">
            <h4>Transcription Result</h4>
            <span [class]="testResult.debug_info?.service_mode === 'mock' ? 'mock-badge' : 'real-badge'">
              {{ testResult.debug_info?.service_mode || 'real' }} mode
            </span>
          </div>
          
          <div class="result-content">
            <div class="result-item">
              <strong>Transcript:</strong>
              <p class="transcript-text">{{ testResult.transcript_text || 'No transcript available' }}</p>
            </div>
            
            <div class="result-details">
              <div class="detail-item" *ngIf="testResult.duration">
                <mat-icon>schedule</mat-icon>
                <span>Duration: {{ testResult.duration }}s</span>
              </div>
              <div class="detail-item" *ngIf="testResult.model">
                <mat-icon>smart_toy</mat-icon>
                <span>Model: {{ testResult.model }}</span>
              </div>
              <div class="detail-item" *ngIf="testResult.language">
                <mat-icon>language</mat-icon>
                <span>Language: {{ testResult.language }}</span>
              </div>
              <div class="detail-item" *ngIf="testResult.confidence">
                <mat-icon>verified</mat-icon>
                <span>Confidence: {{ (testResult.confidence * 100).toFixed(1) }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Display -->
        <div *ngIf="testError" class="error-message">
          <mat-icon>error</mat-icon>
          <span>{{ testError }}</span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>