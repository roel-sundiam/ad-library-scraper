<div class="facebook-ads-dashboard">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading Facebook Ads Analysis Results...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage" class="error-container">
    <mat-icon class="error-icon">error</mat-icon>
    <h3>Analysis Results Not Available</h3>
    <p>{{ errorMessage }}</p>
    <button mat-raised-button color="primary" routerLink="/competitor-analysis">
      Start New Analysis
    </button>
  </div>

  <!-- Results Dashboard -->
  <div *ngIf="!isLoading && !errorMessage && analysisResults" class="dashboard-content">
    
    <!-- Header Section -->
    <div class="dashboard-header">
      <div class="header-content">
        <h1>
          <mat-icon>analytics</mat-icon>
          Facebook Ads Competitive Analysis
        </h1>
        <p>Live analysis of {{ brandComparisons.length }} brands with {{ totalAds }} total ads</p>
      </div>
      <div class="header-actions">
        <button mat-stroked-button (click)="exportData()">
          <mat-icon>download</mat-icon>
          Export Data
        </button>
        <button mat-raised-button color="primary" routerLink="/competitor-analysis">
          <mat-icon>add</mat-icon>
          New Analysis
        </button>
      </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="metrics-grid">
      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-header">
            <mat-icon class="metric-icon ads">campaign</mat-icon>
            <span class="metric-label">Total Ads Found</span>
          </div>
          <div class="metric-value">{{ totalAds }}</div>
          <div class="metric-subtitle">Facebook Ad Library results</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-header">
            <mat-icon class="metric-icon">business</mat-icon>
            <span class="metric-label">Advertisers</span>
          </div>
          <div class="metric-value">{{ totalAdvertisers }}</div>
          <div class="metric-subtitle">Unique brands analyzed</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-header">
            <mat-icon class="metric-icon">play_circle</mat-icon>
            <span class="metric-label">Video Content</span>
          </div>
          <div class="metric-value">{{ formatPercentage(videoContentRate) }}</div>
          <div class="metric-subtitle">Ads with video content</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-content>
          <div class="metric-header">
            <mat-icon class="metric-icon">movie</mat-icon>
            <span class="metric-label">Video Ads</span>
          </div>
          <div class="metric-value">{{ totalVideoAds }}</div>
          <div class="metric-subtitle">Total video advertisements</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Brand Comparison Section -->
    <div class="section-container">
      <mat-card class="comparison-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>compare</mat-icon>
            Brand Performance Comparison
          </mat-card-title>
          <mat-card-subtitle>Compare advertising metrics across competitors</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <!-- Metric Selector -->
          <div class="metric-selector">
            <mat-button-toggle-group [(value)]="selectedMetric" (change)="onMetricChange($event.value)">
              <mat-button-toggle value="impressions">Video Rate</mat-button-toggle>
              <mat-button-toggle value="spend">Avg Text Length</mat-button-toggle>
              <mat-button-toggle value="cpm">Video Ads</mat-button-toggle>
              <mat-button-toggle value="ctr">Image Ads</mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          <!-- Brand Comparison Bars -->
          <div class="comparison-bars">
            <div *ngFor="let brand of brandComparisons; let i = index" class="brand-bar">
              <div class="brand-info">
                <div class="brand-name">{{ brand.brand }}</div>
                <div class="brand-stats">
                  <span class="ads-count">{{ brand.ad_frequency }} ads</span>
                  <span class="market-share">{{ formatPercentage(brand.market_share) }} share</span>
                </div>
              </div>
              
              <div class="progress-container">
                <div class="progress-bar" 
                     [style.width.%]="(getMetricValue(brand, selectedMetric) / getMetricValue(brandComparisons[0], selectedMetric)) * 100"
                     [style.background-color]="getBrandColor(i)">
                </div>
                <span class="metric-value-text">
                  <span *ngIf="selectedMetric === 'impressions'">{{ formatPercentage(brand.metrics.total_impressions) }}</span>
                  <span *ngIf="selectedMetric === 'spend'">{{ brand.metrics.total_spend.toFixed(0) }} chars</span>
                  <span *ngIf="selectedMetric === 'cpm'">{{ brand.metrics.average_cpm }} videos</span>
                  <span *ngIf="selectedMetric === 'ctr'">{{ brand.metrics.average_ctr }} images</span>
                </span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Top Performing Ads Section -->
    <div class="section-container">
      <mat-card class="top-ads-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>schedule</mat-icon>
            Recent Ads
          </mat-card-title>
          <mat-card-subtitle>Most recently published ads across all brands</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="ads-grid">
            <div *ngFor="let ad of topPerformingAds; let i = index" 
                 class="ad-card" 
                 (click)="openAdDetails(ad)">
              
              <div class="ad-header">
                <div class="advertiser-info">
                  <span class="advertiser-name">{{ ad.advertiser.name }}</span>
                  <mat-icon *ngIf="ad.advertiser.verified" class="verified-badge" title="Verified">verified</mat-icon>
                </div>
                <div class="ad-rank">#{{ i + 1 }}</div>
              </div>

              <div class="ad-content">
                <div class="ad-text">{{ getAdPreviewText(ad) }}</div>
                <div *ngIf="ad.creative.images.length > 0" class="ad-media">
                  <mat-icon>image</mat-icon>
                  <span>{{ ad.creative.images.length }} image(s)</span>
                </div>
                <div *ngIf="ad.creative.has_video" class="ad-media">
                  <mat-icon>play_circle</mat-icon>
                  <span>Video content</span>
                </div>
              </div>

              <div class="ad-metrics">
                <div class="metric-item">
                  <span class="metric-label">Format</span>
                  <span class="metric-value">{{ ad.creative.has_video ? 'Video' : 'Image' }}</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Text Length</span>
                  <span class="metric-value">{{ ad.creative.body?.length || 0 }} chars</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">Status</span>
                  <span class="metric-value">{{ ad.metadata.is_active ? 'Active' : 'Historical' }}</span>
                </div>
              </div>

              <div class="ad-footer">
                <div class="ad-source">
                  <mat-icon>source</mat-icon>
                  <span>{{ ad.metadata.source }}</span>
                </div>
                <div class="ad-date">
                  {{ ad.dates.start_date | date:'MMM d, y' }}
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="topPerformingAds.length === 0" class="no-ads-message">
            <mat-icon>info</mat-icon>
            <p>No ad performance data available</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Detailed Brand Analysis -->
    <div class="section-container" *ngFor="let brand of brandComparisons; let i = index">
      <mat-card class="brand-detail-card">
        <mat-card-header>
          <mat-card-title>
            <div class="brand-header">
              <div class="brand-indicator" [style.background-color]="getBrandColor(i)"></div>
              {{ brand.brand }} Analysis
            </div>
          </mat-card-title>
          <mat-card-subtitle>{{ brand.ad_frequency }} ads found â€¢ {{ formatPercentage(brand.market_share) }} market share</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="brand-metrics-grid">
            <div class="brand-metric">
              <div class="metric-icon-container impressions">
                <mat-icon>play_circle</mat-icon>
              </div>
              <div class="metric-details">
                <div class="metric-value">{{ formatPercentage(brand.metrics.total_impressions) }}</div>
                <div class="metric-label">Video Content Rate</div>
              </div>
            </div>

            <div class="brand-metric">
              <div class="metric-icon-container spend">
                <mat-icon>text_fields</mat-icon>
              </div>
              <div class="metric-details">
                <div class="metric-value">{{ brand.metrics.total_spend.toFixed(0) }}</div>
                <div class="metric-label">Avg Text Length</div>
              </div>
            </div>

            <div class="brand-metric">
              <div class="metric-icon-container cpm">
                <mat-icon>movie</mat-icon>
              </div>
              <div class="metric-details">
                <div class="metric-value">{{ brand.metrics.average_cpm }}</div>
                <div class="metric-label">Video Ads</div>
              </div>
            </div>

            <div class="brand-metric">
              <div class="metric-icon-container ctr">
                <mat-icon>image</mat-icon>
              </div>
              <div class="metric-details">
                <div class="metric-value">{{ brand.metrics.average_ctr }}</div>
                <div class="metric-label">Image Ads</div>
              </div>
            </div>
          </div>

          <!-- Creative Types Distribution -->
          <div class="creative-types">
            <h4>Creative Types</h4>
            <div class="creative-distribution">
              <div class="creative-type">
                <mat-icon>image</mat-icon>
                <span>{{ brand.creative_types.image }} Images</span>
              </div>
              <div class="creative-type">
                <mat-icon>play_circle</mat-icon>
                <span>{{ brand.creative_types.video }} Videos</span>
              </div>
              <div class="creative-type">
                <mat-icon>view_carousel</mat-icon>
                <span>{{ brand.creative_types.carousel }} Carousels</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- AI Analysis & Chat Section -->
    <div class="section-container">
      <mat-card class="ai-analysis-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>smart_toy</mat-icon>
            AI Analysis & Chat
          </mat-card-title>
          <mat-card-subtitle>Get AI-powered insights and ask questions about your competitor analysis</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <!-- Custom Analysis Section -->
          <div class="custom-analysis-section">
            <h4>
              <mat-icon>psychology</mat-icon>
              Custom AI Analysis
            </h4>
            <p>Ask AI to analyze your competitor data with a custom prompt:</p>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Enter your analysis prompt...</mat-label>
              <textarea 
                matInput 
                [(ngModel)]="customPrompt" 
                rows="3"
                placeholder="e.g., 'Analyze video content strategies across competitors' or 'What messaging themes are most common?'"
              ></textarea>
            </mat-form-field>
            
            <div class="analysis-actions">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="runCustomAnalysis()"
                [disabled]="!customPrompt.trim() || isAnalyzing"
              >
                <mat-icon *ngIf="!isAnalyzing">psychology</mat-icon>
                <mat-spinner *ngIf="isAnalyzing" diameter="20"></mat-spinner>
                {{ isAnalyzing ? 'Analyzing...' : 'Run AI Analysis' }}
              </button>
              
              <button mat-stroked-button (click)="showQuickPrompts = !showQuickPrompts">
                <mat-icon>help_outline</mat-icon>
                Quick Prompts
              </button>
            </div>

            <!-- Quick Prompt Suggestions -->
            <div *ngIf="showQuickPrompts" class="quick-prompts">
              <h5>Quick Prompt Ideas:</h5>
              <div class="prompt-chips">
                <button 
                  *ngFor="let prompt of quickPrompts" 
                  mat-stroked-button 
                  (click)="useQuickPrompt(prompt)"
                  class="prompt-chip"
                >
                  {{ prompt }}
                </button>
              </div>
            </div>

            <!-- Analysis Results -->
            <div *ngIf="customAnalysisResult" class="analysis-results">
              <mat-divider></mat-divider>
              <h5>
                <mat-icon>insights</mat-icon>
                Analysis Results
                <span class="ai-provider">({{ customAnalysisResult.metadata?.ai_provider || 'AI' }})</span>
              </h5>
              <div class="analysis-content" [innerHTML]="formatAnalysisResult(customAnalysisResult.analysis)"></div>
            </div>
          </div>

          <mat-divider class="section-divider"></mat-divider>

          <!-- AI Chat Interface -->
          <div class="ai-chat-section">
            <h4>
              <mat-icon>chat</mat-icon>
              Chat with AI About Your Analysis
            </h4>
            <p>Ask follow-up questions about your competitor analysis results:</p>
            
            <!-- Integrate the AI Chat Component -->
            <app-ai-chat [analysisResults]="getAnalysisResultsForChat()"></app-ai-chat>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Analysis Meta Information -->
    <div class="section-container">
      <mat-card class="meta-info-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info</mat-icon>
            Analysis Information
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="meta-grid">
            <div class="meta-item">
              <span class="meta-label">Analysis ID:</span>
              <span class="meta-value">{{ datasetId }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Total Brands:</span>
              <span class="meta-value">{{ brandComparisons.length }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Total Ads Found:</span>
              <span class="meta-value">{{ totalAds }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Data Sources:</span>
              <span class="meta-value">{{ analysisResults.meta?.data_sources?.join(', ') || 'Multiple' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Analysis Duration:</span>
              <span class="meta-value">{{ analysisResults.meta?.analysis_duration || 'N/A' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

  </div>
</div>