<div class="dashboard-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-content">
      <div class="loading-animation">
        <mat-spinner diameter="60"></mat-spinner>
      </div>
      <h2>Analyzing Competitor Data</h2>
      <p>Processing Facebook ads data with AI-powered insights...</p>
      <div class="loading-steps">
        <div class="step active">
          <mat-icon>data_exploration</mat-icon>
          <span>Collecting Data</span>
        </div>
        <div class="step">
          <mat-icon>analytics</mat-icon>
          <span>Processing</span>
        </div>
        <div class="step">
          <mat-icon>insights</mat-icon>
          <span>Generating Insights</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage" class="error-state">
    <div class="error-content">
      <div class="error-icon">
        <mat-icon>error_outline</mat-icon>
      </div>
      <h2>Analysis Unavailable</h2>
      <p>{{ errorMessage }}</p>
      <div class="error-actions">
        <button mat-flat-button color="primary" routerLink="/competitor-analysis">
          <mat-icon>refresh</mat-icon>
          Start New Analysis
        </button>
      </div>
    </div>
  </div>

  <!-- Results Dashboard -->
  <div *ngIf="!isLoading && !errorMessage && analysisResults" class="dashboard-content">
    
    <!-- Modern Header -->
    <header class="dashboard-header">
      <div class="header-background">
        <div class="gradient-overlay"></div>
      </div>
      <div class="header-content">
        <div class="breadcrumb">
          <a routerLink="/competitor-analysis">
            <mat-icon>arrow_back</mat-icon>
            <span>Back to Analysis</span>
          </a>
        </div>
        <div class="title-section">
          <div class="competitor-badge">
            <mat-icon>business</mat-icon>
            <span>{{ brandComparisons[0]?.brand || 'Competitor' }}</span>
          </div>
          <h1>Intelligence Dashboard</h1>
          <p class="subtitle">Comprehensive analysis of {{ totalAds }} Facebook advertisements with AI-powered insights</p>
        </div>
        <div class="header-stats">
          <div class="stat-chip">
            <mat-icon>campaign</mat-icon>
            <span>{{ totalAds }} Ads</span>
          </div>
          <div class="stat-chip">
            <mat-icon>play_circle</mat-icon>
            <span>{{ totalVideoAds }} Videos</span>
          </div>
          <div class="stat-chip">
            <mat-icon>trending_up</mat-icon>
            <span>{{ formatPercentage(videoContentRate) }} Video Rate</span>
          </div>
        </div>
        <div class="header-actions">
          <button mat-stroked-button (click)="exportData()" class="action-btn">
            <mat-icon>download</mat-icon>
            <span>Export</span>
          </button>
          <button mat-flat-button color="primary" routerLink="/competitor-analysis" class="action-btn">
            <mat-icon>add</mat-icon>
            <span>New Analysis</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Modern Metrics Overview -->
    <section class="metrics-section">
      <div class="metrics-header">
        <h2>Performance Overview</h2>
        <p>Key insights from your competitor analysis</p>
      </div>
      <div class="metrics-grid">
        <div class="metric-card primary">
          <div class="metric-icon">
            <mat-icon>insights</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ totalAds }}</div>
            <div class="metric-label">Total Advertisements</div>
            <div class="metric-trend positive">
              <mat-icon>trending_up</mat-icon>
              <span>Active campaign</span>
            </div>
          </div>
        </div>

        <div class="metric-card secondary" (click)="showVideoAds()">
          <div class="metric-icon">
            <mat-icon>movie_creation</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ totalVideoAds }}</div>
            <div class="metric-label">Video Content</div>
            <div class="metric-trend">
              <mat-icon>play_circle</mat-icon>
              <span>{{ formatPercentage(videoContentRate) }} of ads</span>
            </div>
          </div>
          <div class="metric-action">
            <mat-icon>open_in_new</mat-icon>
          </div>
        </div>

        <div class="metric-card accent">
          <div class="metric-icon">
            <mat-icon>psychology</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">AI</div>
            <div class="metric-label">Analysis Ready</div>
            <div class="metric-trend">
              <mat-icon>smart_toy</mat-icon>
              <span>{{ totalVideoAds }} videos queued</span>
            </div>
          </div>
        </div>

        <div class="metric-card highlight">
          <div class="metric-icon">
            <mat-icon>business</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value competitor-name">{{ (brandComparisons[0]?.brand || 'Competitor').substring(0, 12) }}</div>
            <div class="metric-label">Target Competitor</div>
            <div class="metric-trend">
              <mat-icon>verified</mat-icon>
              <span>Analysis complete</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Competitor Intelligence Section -->
    <section class="intelligence-section">
      <div class="section-header">
        <h2>
          <mat-icon>insights</mat-icon>
          Competitive Intelligence
        </h2>
        <p>Deep dive into {{ brandComparisons[0]?.brand || 'competitor' }}'s advertising strategy</p>
      </div>
      
      <div class="intelligence-grid">
        <!-- Strategy Overview -->
        <div class="intelligence-card strategy-card">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>lightbulb</mat-icon>
            </div>
            <h3>Strategy Overview</h3>
          </div>
          <div class="card-content">
            <div class="strategy-stats">
              <div class="strategy-stat">
                <span class="stat-number">{{ brandComparisons[0]?.ad_frequency || 0 }}</span>
                <span class="stat-label">Total Campaigns</span>
              </div>
              <div class="strategy-stat">
                <span class="stat-number">{{ formatPercentage(videoContentRate) }}</span>
                <span class="stat-label">Video Focus</span>
              </div>
              <div class="strategy-stat">
                <span class="stat-number">{{ brandComparisons[0]?.metrics?.total_spend?.toFixed(0) || 0 }}</span>
                <span class="stat-label">Avg Text Length</span>
              </div>
            </div>
            <div class="strategy-insight">
              <mat-icon>info</mat-icon>
              <span>{{ brandComparisons[0]?.brand || 'Competitor' }} shows {{ videoContentRate > 30 ? 'heavy' : videoContentRate > 15 ? 'moderate' : 'light' }} video content focus</span>
            </div>
          </div>
        </div>

        <!-- Creative Distribution -->
        <div class="intelligence-card creative-card">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>palette</mat-icon>
            </div>
            <h3>Creative Mix</h3>
          </div>
          <div class="card-content">
            <div class="creative-breakdown">
              <div class="creative-type" (click)="showBrandVideos(brandComparisons[0]?.brand || 'Competitor')">
                <div class="type-icon video">
                  <mat-icon>play_circle</mat-icon>
                </div>
                <div class="type-info">
                  <span class="type-count">{{ brandComparisons[0]?.creative_types?.video || 0 }}</span>
                  <span class="type-label">Video Ads</span>
                </div>
                <mat-icon class="action-icon">arrow_forward</mat-icon>
              </div>
              <div class="creative-type">
                <div class="type-icon image">
                  <mat-icon>image</mat-icon>
                </div>
                <div class="type-info">
                  <span class="type-count">{{ brandComparisons[0]?.creative_types?.image || 0 }}</span>
                  <span class="type-label">Image Ads</span>
                </div>
              </div>
              <div class="creative-type">
                <div class="type-icon carousel">
                  <mat-icon>view_carousel</mat-icon>
                </div>
                <div class="type-info">
                  <span class="type-count">{{ brandComparisons[0]?.creative_types?.carousel || 0 }}</span>
                  <span class="type-label">Carousel Ads</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Market Position -->
        <div class="intelligence-card position-card">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <h3>Market Position</h3>
          </div>
          <div class="card-content">
            <div class="position-score">
              <div class="score-circle">
                <span class="score-value">{{ (brandComparisons[0]?.market_share || 0).toFixed(0) }}%</span>
              </div>
              <span class="score-label">Market Share</span>
            </div>
            <div class="position-insights">
              <div class="insight-item">
                <mat-icon>schedule</mat-icon>
                <span>Active campaign strategy</span>
              </div>
              <div class="insight-item">
                <mat-icon>trending_up</mat-icon>
                <span>{{ videoContentRate > 25 ? 'High' : 'Standard' }} video engagement</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Recent Ads Gallery -->
    <section class="ads-section">
      <div class="section-header">
        <h2>
          <mat-icon>history</mat-icon>
          Recent Advertisements
        </h2>
        <p>Latest ads from {{ brandComparisons[0]?.brand || 'competitor' }}'s campaign</p>
      </div>
      
      <div class="ads-gallery" *ngIf="topPerformingAds.length > 0">
        <div *ngFor="let ad of topPerformingAds; let i = index" 
             class="ad-showcase" 
             (click)="openAdDetails(ad)">
          <div class="ad-badge">
            <span class="ad-number">#{{ i + 1 }}</span>
            <div class="ad-type" [ngClass]="ad.creative.has_video ? 'video' : 'image'">
              <mat-icon>{{ ad.creative.has_video ? 'play_circle' : 'image' }}</mat-icon>
            </div>
          </div>
          
          <div class="ad-preview">
            <div class="advertiser-badge">
              <mat-icon>business</mat-icon>
              <span>{{ ad.advertiser.name }}</span>
              <mat-icon *ngIf="ad.advertiser.verified" class="verified">verified</mat-icon>
            </div>
            
            <div class="ad-content">
              <p class="ad-text">{{ getAdPreviewText(ad) }}</p>
            </div>
            
            <div class="ad-meta">
              <div class="meta-item">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ ad.dates.start_date | date:'MMM d' }}</span>
              </div>
              <div class="meta-item">
                <mat-icon>text_fields</mat-icon>
                <span>{{ ad.creative.body?.length || 0 }} chars</span>
              </div>
              <div class="meta-item status" [ngClass]="ad.metadata.is_active ? 'active' : 'historical'">
                <mat-icon>{{ ad.metadata.is_active ? 'radio_button_checked' : 'history' }}</mat-icon>
                <span>{{ ad.metadata.is_active ? 'Active' : 'Historical' }}</span>
              </div>
            </div>
          </div>
          
          <div class="ad-actions">
            <button mat-icon-button class="action-btn" title="View Details">
              <mat-icon>open_in_new</mat-icon>
            </button>
          </div>
        </div>
      </div>
      
      <div *ngIf="topPerformingAds.length === 0" class="no-ads-state">
        <div class="no-ads-icon">
          <mat-icon>search_off</mat-icon>
        </div>
        <h3>No Recent Ads Found</h3>
        <p>No advertisement data is available for analysis</p>
      </div>
    </section>

    <!-- Brand Deep Dive -->
    <section class="brand-analysis-section" *ngFor="let brand of brandComparisons; let i = index">
      <div class="brand-analysis-card">
        <div class="brand-header">
          <div class="brand-identity">
            <div class="brand-avatar" [style.background]="getBrandColor(i)">
              <span class="brand-initial">{{ (brand.brand || 'C').charAt(0).toUpperCase() }}</span>
            </div>
            <div class="brand-info">
              <h3>{{ brand.brand }} Deep Dive</h3>
              <p>{{ brand.ad_frequency }} campaigns • {{ formatPercentage(brand.market_share) }} market presence</p>
            </div>
          </div>
          <div class="brand-score">
            <div class="score-ring">
              <span class="score-value">{{ (brand.market_share || 0).toFixed(0) }}</span>
            </div>
            <span class="score-label">Activity Score</span>
          </div>
        </div>
        
        <div class="brand-content">
          <div class="performance-grid">
            <div class="performance-metric video">
              <div class="metric-icon">
                <mat-icon>play_circle</mat-icon>
              </div>
              <div class="metric-data">
                <span class="metric-number">{{ formatPercentage(brand.metrics.total_impressions) }}</span>
                <span class="metric-label">Video Content Rate</span>
                <div class="metric-trend positive">
                  <mat-icon>trending_up</mat-icon>
                  <span>Strong video focus</span>
                </div>
              </div>
            </div>
            
            <div class="performance-metric text">
              <div class="metric-icon">
                <mat-icon>article</mat-icon>
              </div>
              <div class="metric-data">
                <span class="metric-number">{{ brand.metrics.total_spend.toFixed(0) }}</span>
                <span class="metric-label">Avg Text Length</span>
                <div class="metric-trend">
                  <mat-icon>text_fields</mat-icon>
                  <span>{{ brand.metrics.total_spend > 100 ? 'Detailed' : 'Concise' }}</span>
                </div>
              </div>
            </div>
            
            <div class="performance-metric content">
              <div class="metric-icon">
                <mat-icon>library_books</mat-icon>
              </div>
              <div class="metric-data">
                <span class="metric-number">{{ brand.metrics.average_cpm + brand.metrics.average_ctr }}</span>
                <span class="metric-label">Total Content</span>
                <div class="metric-trend">
                  <mat-icon>inventory</mat-icon>
                  <span>{{ brand.metrics.average_cpm > 10 ? 'High' : 'Moderate' }} volume</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="creative-breakdown">
            <h4>Creative Portfolio</h4>
            <div class="portfolio-items">
              <div class="portfolio-item" (click)="showBrandVideos(brand.brand || 'Competitor')">
                <div class="item-icon video">
                  <mat-icon>movie_creation</mat-icon>
                </div>
                <div class="item-details">
                  <span class="item-count">{{ brand.creative_types.video }}</span>
                  <span class="item-label">Video Campaigns</span>
                </div>
                <mat-icon class="item-action">launch</mat-icon>
              </div>
              
              <div class="portfolio-item">
                <div class="item-icon image">
                  <mat-icon>photo_library</mat-icon>
                </div>
                <div class="item-details">
                  <span class="item-count">{{ brand.creative_types.image }}</span>
                  <span class="item-label">Image Campaigns</span>
                </div>
              </div>
              
              <div class="portfolio-item">
                <div class="item-icon carousel">
                  <mat-icon>view_carousel</mat-icon>
                </div>
                <div class="item-details">
                  <span class="item-count">{{ brand.creative_types.carousel }}</span>
                  <span class="item-label">Carousel Campaigns</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AI Analysis & Chat Section -->
    <section class="ai-analysis-section">
      <div class="ai-analysis-container">
        <!-- Modern Header -->
        <div class="ai-header">
          <div class="header-background">
            <div class="ai-gradient-overlay"></div>
          </div>
          <div class="header-content">
            <div class="ai-icon-badge">
              <mat-icon>psychology</mat-icon>
            </div>
            <div class="header-text">
              <h2>AI-Powered Analysis</h2>
              <p>Get intelligent insights and chat about your competitor analysis with advanced AI</p>
            </div>
            <div class="ai-status-indicator">
              <div class="status-dot active"></div>
              <span>AI Ready</span>
            </div>
          </div>
        </div>
        
        <!-- Modern Content Area -->
        <div class="ai-content-area">
          <!-- Analysis Mode Toggle -->
          <div class="modern-mode-toggle">
            <div class="toggle-header">
              <h3>Choose Analysis Type</h3>
              <p>Select the type of AI analysis you want to perform</p>
            </div>
            <div class="toggle-cards">
              <div class="mode-card" 
                   [class.active]="analysisMode === 'general'"
                   (click)="switchAnalysisMode('general')">
                <div class="card-icon general">
                  <mat-icon>analytics</mat-icon>
                </div>
                <div class="card-content">
                  <h4>General Analysis</h4>
                  <p>Custom AI insights and analysis</p>
                </div>
                <div class="card-indicator" *ngIf="analysisMode === 'general'">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
              
              <div class="mode-card" 
                   [class.active]="analysisMode === 'video'"
                   (click)="switchAnalysisMode('video')">
                <div class="card-icon video">
                  <mat-icon>movie_creation</mat-icon>
                </div>
                <div class="card-content">
                  <h4>Bulk Video Analysis</h4>
                  <p>Analyze all {{ totalVideoAds }} videos with AI</p>
                </div>
                <div class="card-indicator" *ngIf="analysisMode === 'video'">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
              
              <div class="mode-card" 
                   [class.active]="analysisMode === 'debug'"
                   (click)="switchAnalysisMode('debug')">
                <div class="card-icon debug">
                  <mat-icon>bug_report</mat-icon>
                </div>
                <div class="card-content">
                  <h4>Transcription Debug</h4>
                  <p>Test and verify video transcriptions</p>
                </div>
                <div class="card-indicator" *ngIf="analysisMode === 'debug'">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- General Analysis Section -->
          <div *ngIf="analysisMode === 'general'" class="modern-analysis-section">
            <div class="analysis-card">
              <div class="analysis-card-header">
                <div class="analysis-icon">
                  <mat-icon>psychology</mat-icon>
                </div>
                <div class="analysis-title">
                  <h3>Custom AI Analysis</h3>
                  <p>Ask AI to analyze your competitor data with intelligent insights</p>
                </div>
              </div>
              
              <div class="analysis-card-content">
                <div class="prompt-input-section">
                  <label class="input-label">
                    <mat-icon>edit</mat-icon>
                    Your Analysis Prompt
                  </label>
                  <div class="modern-textarea-container">
                    <textarea 
                      class="modern-textarea"
                      [(ngModel)]="customPrompt" 
                      rows="4"
                      placeholder="e.g., 'Analyze video content strategies across competitors' or 'What messaging themes are most common?'"
                    ></textarea>
                    <div class="textarea-actions">
                      <button class="quick-prompts-btn" (click)="showQuickPrompts = !showQuickPrompts">
                        <mat-icon>lightbulb</mat-icon>
                        <span>Quick Ideas</span>
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="analysis-actions">
                  <button 
                    class="primary-analysis-btn"
                    (click)="runCustomAnalysis()"
                    [disabled]="!customPrompt.trim() || isAnalyzing"
                  >
                    <div class="btn-content">
                      <mat-icon *ngIf="!isAnalyzing">psychology</mat-icon>
                      <mat-spinner *ngIf="isAnalyzing" diameter="20"></mat-spinner>
                      <span>{{ isAnalyzing ? 'Analyzing...' : 'Run AI Analysis' }}</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>

            <!-- Quick Prompt Suggestions -->
            <div *ngIf="showQuickPrompts" class="modern-quick-prompts">
              <div class="prompts-header">
                <mat-icon>auto_awesome</mat-icon>
                <h4>AI Prompt Suggestions</h4>
              </div>
              <div class="prompts-grid">
                <button 
                  *ngFor="let prompt of quickPrompts" 
                  class="prompt-suggestion-card"
                  (click)="useQuickPrompt(prompt)"
                >
                  <mat-icon>spark</mat-icon>
                  <span>{{ prompt }}</span>
                </button>
              </div>
            </div>

            <!-- Analysis Results -->
            <div *ngIf="customAnalysisResult" class="modern-analysis-results">
              <div class="results-header">
                <div class="results-icon">
                  <mat-icon>insights</mat-icon>
                </div>
                <div class="results-title">
                  <h3>AI Analysis Results</h3>
                  <div class="ai-provider-badge">
                    <mat-icon>smart_toy</mat-icon>
                    <span>{{ customAnalysisResult.metadata?.ai_provider || 'AI' }}</span>
                  </div>
                </div>
              </div>
              <div class="results-content">
                <div class="analysis-output" [innerHTML]="formatAnalysisResult(customAnalysisResult.analysis)"></div>
              </div>
            </div>
          </div>

          <!-- Bulk Video Analysis Section -->
          <div *ngIf="analysisMode === 'video'" class="modern-video-analysis-section">
            <div class="video-analysis-card">
              <div class="video-analysis-header">
                <div class="video-icon-badge">
                  <mat-icon>movie_creation</mat-icon>
                </div>
                <div class="video-title">
                  <h3>Bulk Video Analysis</h3>
                  <p>Analyze ALL competitor videos ({{ totalVideoAds }} videos) with AI-powered insights</p>
                </div>
                <div class="video-count-badge">
                  <span class="count">{{ totalVideoAds }}</span>
                  <span class="label">Videos</span>
                </div>
              </div>
              
              <!-- Video Analysis Options -->
              <div class="modern-analysis-options">
                <h4>Analysis Options</h4>
                <div class="options-grid">
                  <div class="option-card" [class.enabled]="includeTranscripts">
                    <label class="option-label">
                      <input type="checkbox" [(ngModel)]="includeTranscripts" class="hidden-checkbox">
                      <div class="option-content">
                        <div class="option-icon">
                          <mat-icon>subtitles</mat-icon>
                        </div>
                        <div class="option-text">
                          <span class="option-title">Video Transcripts</span>
                          <span class="option-desc">OpenAI Whisper powered</span>
                        </div>
                        <div class="option-toggle">
                          <div class="toggle-indicator"></div>
                        </div>
                      </div>
                    </label>
                  </div>
                  
                  <div class="option-card disabled">
                    <div class="option-content">
                      <div class="option-icon">
                        <mat-icon>visibility</mat-icon>
                      </div>
                      <div class="option-text">
                        <span class="option-title">Visual Analysis</span>
                        <span class="option-desc">Coming Soon</span>
                      </div>
                      <div class="coming-soon-badge">
                        <mat-icon>schedule</mat-icon>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Video Analysis Templates -->
              <div class="modern-templates-section">
                <div class="templates-header">
                  <div class="templates-title">
                    <mat-icon>auto_awesome</mat-icon>
                    <h4>Analysis Templates</h4>
                  </div>
                  <button class="templates-toggle-btn" (click)="showVideoTemplates = !showVideoTemplates">
                    <span>{{ videoAnalysisTemplates.length }} Professional Templates</span>
                    <mat-icon>{{ showVideoTemplates ? 'expand_less' : 'expand_more' }}</mat-icon>
                  </button>
                </div>

                <div *ngIf="showVideoTemplates" class="modern-templates-grid">
                  <div *ngFor="let template of videoAnalysisTemplates" 
                       class="modern-template-card"
                       [class.selected]="selectedVideoTemplate === template.id"
                       (click)="useVideoTemplate(template.id)">
                    <div class="template-content">
                      <div class="template-icon">
                        <mat-icon>description</mat-icon>
                      </div>
                      <div class="template-info">
                        <h5>{{ template.name }}</h5>
                        <p>{{ template.description }}</p>
                      </div>
                      <div class="template-selector" *ngIf="selectedVideoTemplate === template.id">
                        <mat-icon>check_circle</mat-icon>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Custom Prompt Section -->
              <div class="video-prompt-section">
                <label class="prompt-label">
                  <mat-icon>edit</mat-icon>
                  Custom Video Analysis Prompt
                </label>
                <div class="video-textarea-container">
                  <textarea 
                    class="video-textarea"
                    [(ngModel)]="customPrompt" 
                    rows="5"
                    placeholder="Describe what insights you want from the competitor's video content..."
                  ></textarea>
                  <div class="textarea-hint">
                    <mat-icon>lightbulb</mat-icon>
                    <span>Tip: Use templates above or create your own analysis prompt for {{ totalVideoAds }} videos</span>
                  </div>
                </div>
              </div>
              
              <!-- Analysis Options -->
              <div class="video-analysis-options">
                <div class="options-section">
                  <h4 class="options-title">
                    <mat-icon>tune</mat-icon>
                    Analysis Options
                  </h4>
                  
                  <div class="option-toggles">
                    <div class="toggle-option">
                      <mat-slide-toggle 
                        [(ngModel)]="includeTranscripts"
                        color="primary">
                        <span class="toggle-label">
                          <strong>Include Video Transcripts</strong>
                          <span class="recommended-badge">RECOMMENDED</span>
                        </span>
                      </mat-slide-toggle>
                      <div class="option-description">
                        <mat-icon class="info-icon">info</mat-icon>
                        <span><strong>Analyzes actual video content</strong> instead of just ad text for genuine insights</span>
                        <div class="cost-warning prominent" *ngIf="includeTranscripts">
                          <mat-icon class="warning-icon">attach_money</mat-icon>
                          <span><strong>Additional OpenAI cost:</strong> ~$0.006/minute (~$0.15 for {{ totalVideoAds }} videos)</span>
                        </div>
                        <div class="fallback-warning" *ngIf="!includeTranscripts">
                          <mat-icon class="warning-icon">warning</mat-icon>
                          <span><strong>Warning:</strong> Without transcription, analysis will be based on repetitive ad text only</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="toggle-option">
                      <mat-slide-toggle 
                        [(ngModel)]="includeVisualAnalysis"
                        color="primary"
                        [disabled]="true">
                        <span class="toggle-label">Visual Analysis (Coming Soon)</span>
                      </mat-slide-toggle>
                      <div class="option-description">
                        <mat-icon class="info-icon">info</mat-icon>
                        <span>AI analysis of visual elements, colors, and design patterns</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Analysis Actions -->
              <div class="video-analysis-actions">
                <button 
                  class="video-analyze-btn"
                  (click)="startBulkVideoAnalysis()"
                  [disabled]="!customPrompt.trim() || isBulkAnalyzing || totalVideoAds === 0">
                  <div class="btn-content">
                    <mat-icon *ngIf="!isBulkAnalyzing">smart_toy</mat-icon>
                    <mat-spinner *ngIf="isBulkAnalyzing" diameter="22"></mat-spinner>
                    <span>{{ isBulkAnalyzing ? 'Analyzing Videos...' : 'Analyze ' + totalVideoAds + ' Videos' }}</span>
                  </div>
                </button>
                
                <button 
                  *ngIf="isBulkAnalyzing"
                  class="cancel-btn"
                  (click)="cancelBulkAnalysis()">
                  <mat-icon>stop</mat-icon>
                  <span>Cancel Analysis</span>
                </button>
              </div>
            </div>

            <!-- Progress Tracking -->
            <div *ngIf="bulkAnalysisProgress" class="video-analysis-progress">
              <div class="progress-card">
                <div class="progress-header">
                  <div class="progress-title">
                    <mat-icon class="progress-icon">smart_toy</mat-icon>
                    <h5>{{ bulkAnalysisProgress.message || 'Processing video analysis...' }}</h5>
                  </div>
                </div>
                
                <div class="progress-bar-container">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="bulkAnalysisProgress.percentage || 0"
                    class="themed-progress-bar">
                  </mat-progress-bar>
                  <span class="progress-percentage">{{ bulkAnalysisProgress.percentage || 0 }}%</span>
                </div>
                
                <div class="progress-stages">
                  <div class="stage-item" 
                       [class.active]="bulkAnalysisProgress.stage === 'initializing'"
                       [class.completed]="getStageStatus('initializing')">
                    <div class="stage-icon">
                      <mat-icon>{{ getStageIcon('initializing') }}</mat-icon>
                    </div>
                    <span class="stage-label">Initializing</span>
                  </div>
                  
                  <div class="stage-connector" 
                       [class.completed]="getStageStatus('transcribing') || getStageStatus('analyzing') || getStageStatus('completed')"></div>
                  
                  <div class="stage-item" 
                       [class.active]="bulkAnalysisProgress.stage === 'transcribing'"
                       [class.completed]="getStageStatus('transcribing')">
                    <div class="stage-icon">
                      <mat-icon>{{ getStageIcon('transcribing') }}</mat-icon>
                    </div>
                    <span class="stage-label">Processing</span>
                  </div>
                  
                  <div class="stage-connector" 
                       [class.completed]="getStageStatus('analyzing') || getStageStatus('completed')"></div>
                  
                  <div class="stage-item" 
                       [class.active]="bulkAnalysisProgress.stage === 'analyzing'"
                       [class.completed]="getStageStatus('analyzing')">
                    <div class="stage-icon">
                      <mat-icon>{{ getStageIcon('analyzing') }}</mat-icon>
                    </div>
                    <span class="stage-label">AI Analysis</span>
                  </div>
                  
                  <div class="stage-connector" 
                       [class.completed]="getStageStatus('completed')"></div>
                  
                  <div class="stage-item" 
                       [class.active]="bulkAnalysisProgress.stage === 'completed'"
                       [class.completed]="getStageStatus('completed')">
                    <div class="stage-icon">
                      <mat-icon>{{ getStageIcon('completed') }}</mat-icon>
                    </div>
                    <span class="stage-label">Complete</span>
                  </div>
                </div>
                
                <div class="progress-details" *ngIf="bulkAnalysisProgress.stage !== 'completed'">
                  <small class="progress-note">
                    <mat-icon class="info-icon">info</mat-icon>
                    Analyzing {{ bulkAnalysisProgress.total || 0 }} video advertisements with AI-powered insights
                  </small>
                </div>
              </div>
            </div>

            <!-- Bulk Analysis Results -->
            <div *ngIf="bulkAnalysisResult" class="bulk-analysis-results">
              <mat-divider></mat-divider>
              <div class="results-header">
                <h5>
                  <mat-icon>assessment</mat-icon>
                  Bulk Video Analysis Report
                  <span class="video-count">({{ bulkAnalysisProgress?.total || 0 }} videos analyzed)</span>
                </h5>
                <button mat-stroked-button (click)="downloadBulkAnalysisReport()">
                  <mat-icon>download</mat-icon>
                  Download Report
                </button>
              </div>
              
              <!-- Transcription Statistics -->
              <div *ngIf="bulkAnalysisResult.transcription_stats" class="transcription-stats">
                <div class="stats-header">
                  <mat-icon>transcribe</mat-icon>
                  <span>Video Transcription Results</span>
                </div>
                <div class="stats-grid">
                  <div class="stat-item success" *ngIf="bulkAnalysisResult.transcription_stats.successful > 0">
                    <div class="stat-number">{{ bulkAnalysisResult.transcription_stats.successful }}</div>
                    <div class="stat-label">Transcribed</div>
                  </div>
                  <div class="stat-item failed" *ngIf="bulkAnalysisResult.transcription_stats.failed > 0">
                    <div class="stat-number">{{ bulkAnalysisResult.transcription_stats.failed }}</div>
                    <div class="stat-label">Failed</div>
                  </div>
                  <div class="stat-item skipped" *ngIf="bulkAnalysisResult.transcription_stats.skipped > 0">
                    <div class="stat-number">{{ bulkAnalysisResult.transcription_stats.skipped }}</div>
                    <div class="stat-label">Skipped</div>
                  </div>
                  <div class="stat-item cost" *ngIf="bulkAnalysisResult.transcription_stats.totalCost > 0">
                    <div class="stat-number">${{ bulkAnalysisResult.transcription_stats.totalCost.toFixed(3) }}</div>
                    <div class="stat-label">Cost</div>
                  </div>
                </div>
                <div class="transcription-note" *ngIf="bulkAnalysisResult.transcription_stats.successful === 0">
                  <mat-icon>info</mat-icon>
                  <span>Analysis based on ad text only - video transcription was not enabled or failed</span>
                </div>
                <div class="transcription-note success" *ngIf="bulkAnalysisResult.transcription_stats.successful > 0">
                  <mat-icon>check_circle</mat-icon>
                  <span>Analysis includes actual video content from {{ bulkAnalysisResult.transcription_stats.successful }} transcribed videos</span>
                </div>
              </div>
              
              <!-- Export Actions -->
              <div class="export-actions-section" *ngIf="bulkAnalysisResult">
                <div class="export-header">
                  <mat-icon>file_download</mat-icon>
                  <span>Export Results</span>
                </div>
                <div class="export-buttons">
                  <button mat-stroked-button 
                          color="primary"
                          (click)="exportTranscriptResults()"
                          [disabled]="isExporting"
                          class="export-btn transcripts">
                    <mat-icon>subtitles</mat-icon>
                    {{ isExporting ? 'Exporting...' : 'Export Transcripts' }}
                  </button>
                  
                  <button mat-flat-button 
                          color="primary"
                          (click)="exportAnalysisResults()"
                          [disabled]="isExporting"
                          class="export-btn analysis">
                    <mat-icon>analytics</mat-icon>
                    {{ isExporting ? 'Exporting...' : 'Export Full Analysis' }}
                  </button>
                </div>
                <div class="export-info">
                  <mat-icon>info</mat-icon>
                  <span>Download JSON files containing transcript data and AI analysis for comparison with OpenAI output</span>
                </div>
              </div>
              
              <div class="bulk-analysis-content">
                <div class="analysis-summary" *ngIf="bulkAnalysisResult.summary">
                  <div class="section-header">
                    <h6>Executive Summary</h6>
                    <button *ngIf="shouldShowExpandButton(bulkAnalysisResult.summary, 2000)" 
                            mat-icon-button 
                            (click)="toggleSummaryExpansion()"
                            class="expand-button"
                            [attr.aria-label]="isSummaryExpanded ? 'Collapse summary' : 'Expand summary'">
                      <mat-icon>{{ isSummaryExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </button>
                  </div>
                  <div [innerHTML]="getDisplayContent(bulkAnalysisResult.summary, isSummaryExpanded, 2000)" class="content-section"></div>
                  <div *ngIf="shouldShowExpandButton(bulkAnalysisResult.summary, 2000) && !isSummaryExpanded" class="show-more-hint">
                    <button mat-stroked-button (click)="toggleSummaryExpansion()" class="show-more-btn">
                      <mat-icon>expand_more</mat-icon>
                      Show More Content
                    </button>
                  </div>
                </div>
                
                <div class="detailed-analysis" *ngIf="bulkAnalysisResult.analysis">
                  <div class="section-header">
                    <h6>Detailed Analysis</h6>
                    <button *ngIf="shouldShowExpandButton(bulkAnalysisResult.analysis, 3000)" 
                            mat-icon-button 
                            (click)="toggleAnalysisExpansion()"
                            class="expand-button"
                            [attr.aria-label]="isAnalysisExpanded ? 'Collapse analysis' : 'Expand analysis'">
                      <mat-icon>{{ isAnalysisExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </button>
                  </div>
                  <div [innerHTML]="getDisplayContent(bulkAnalysisResult.analysis, isAnalysisExpanded, 3000)" class="content-section"></div>
                  <div *ngIf="shouldShowExpandButton(bulkAnalysisResult.analysis, 3000) && !isAnalysisExpanded" class="show-more-hint">
                    <button mat-stroked-button (click)="toggleAnalysisExpansion()" class="show-more-btn">
                      <mat-icon>expand_more</mat-icon>
                      Show More Content
                    </button>
                  </div>
                </div>
                
                <div class="recommendations" *ngIf="bulkAnalysisResult.recommendations">
                  <div class="section-header">
                    <h6>Strategic Recommendations</h6>
                    <button *ngIf="shouldShowExpandButton(bulkAnalysisResult.recommendations, 1500)" 
                            mat-icon-button 
                            (click)="toggleRecommendationsExpansion()"
                            class="expand-button"
                            [attr.aria-label]="isRecommendationsExpanded ? 'Collapse recommendations' : 'Expand recommendations'">
                      <mat-icon>{{ isRecommendationsExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                    </button>
                  </div>
                  <div [innerHTML]="getDisplayContent(bulkAnalysisResult.recommendations, isRecommendationsExpanded, 1500)" class="content-section"></div>
                  <div *ngIf="shouldShowExpandButton(bulkAnalysisResult.recommendations, 1500) && !isRecommendationsExpanded" class="show-more-hint">
                    <button mat-stroked-button (click)="toggleRecommendationsExpansion()" class="show-more-btn">
                      <mat-icon>expand_more</mat-icon>
                      Show More Content
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Video Transcription Debug Section -->
          <div *ngIf="analysisMode === 'debug'" class="modern-debug-section">
            <div class="debug-card">
              <div class="debug-header">
                <div class="debug-icon-badge">
                  <mat-icon>bug_report</mat-icon>
                </div>
                <div class="debug-title">
                  <h3>Video Transcription Debug Tools</h3>
                  <p>Test and verify video transcriptions are working correctly</p>
                </div>
              </div>

              <div class="debug-tabs">
                <button mat-flat-button 
                        [color]="debugTab === 'transcriptions' ? 'primary' : ''"
                        (click)="debugTab = 'transcriptions'; loadTranscriptions()"
                        class="debug-tab-btn">
                  <mat-icon>text_fields</mat-icon>
                  View Transcriptions
                </button>
                <button mat-flat-button 
                        [color]="debugTab === 'test' ? 'primary' : ''"
                        (click)="debugTab = 'test'"
                        class="debug-tab-btn">
                  <mat-icon>play_arrow</mat-icon>
                  Test Transcription
                </button>
                <button mat-flat-button 
                        [color]="debugTab === 'videos' ? 'primary' : ''"
                        (click)="debugTab = 'videos'; loadVideoAds()"
                        class="debug-tab-btn">
                  <mat-icon>video_library</mat-icon>
                  Video URLs
                </button>
              </div>

              <!-- Transcriptions Tab -->
              <div *ngIf="debugTab === 'transcriptions'" class="debug-content">
                <div class="debug-section-header">
                  <h4>All Video Transcriptions</h4>
                  <div class="debug-actions">
                    <button mat-stroked-button (click)="loadTranscriptions()">
                      <mat-icon>refresh</mat-icon>
                      Refresh
                    </button>
                    <button mat-flat-button 
                            color="primary"
                            (click)="exportDebugTranscriptions()"
                            [disabled]="isExporting || !transcriptionsData?.transcriptions?.length"
                            class="export-debug-btn">
                      <mat-icon>file_download</mat-icon>
                      {{ isExporting ? 'Exporting...' : 'Export All' }}
                    </button>
                  </div>
                </div>
                
                <div *ngIf="debugLoading" class="debug-loading">
                  <mat-spinner diameter="30"></mat-spinner>
                  <span>Loading transcriptions...</span>
                </div>

                <div *ngIf="!debugLoading && transcriptionsData" class="transcriptions-summary">
                  <div class="summary-stats">
                    <div class="stat-item">
                      <span class="stat-number">{{ transcriptionsData.summary?.total_transcriptions || 0 }}</span>
                      <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item success">
                      <span class="stat-number">{{ transcriptionsData.summary?.successful || 0 }}</span>
                      <span class="stat-label">Successful</span>
                    </div>
                    <div class="stat-item warning">
                      <span class="stat-number">{{ transcriptionsData.summary?.mock_transcriptions || 0 }}</span>
                      <span class="stat-label">Mock</span>
                    </div>
                    <div class="stat-item primary">
                      <span class="stat-number">{{ transcriptionsData.summary?.real_transcriptions || 0 }}</span>
                      <span class="stat-label">Real</span>
                    </div>
                  </div>
                </div>

                <div *ngIf="transcriptionsData?.transcriptions?.length" class="transcriptions-table">
                  <mat-table [dataSource]="transcriptionsData.transcriptions" class="debug-table">
                    <ng-container matColumnDef="advertiser">
                      <mat-header-cell *matHeaderCellDef>Advertiser</mat-header-cell>
                      <mat-cell *matCellDef="let element">{{ element.advertiser }}</mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="transcript_preview">
                      <mat-header-cell *matHeaderCellDef>Transcript Preview</mat-header-cell>
                      <mat-cell *matCellDef="let element">
                        <span class="transcript-preview">{{ element.transcript_text | slice:0:100 }}...</span>
                      </mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="length">
                      <mat-header-cell *matHeaderCellDef>Length</mat-header-cell>
                      <mat-cell *matCellDef="let element">{{ element.transcript_length }} chars</mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="model">
                      <mat-header-cell *matHeaderCellDef>Model</mat-header-cell>
                      <mat-cell *matCellDef="let element">
                        <span [class]="element.model === 'mock-whisper-1' ? 'mock-badge' : 'real-badge'">
                          {{ element.model }}
                        </span>
                      </mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="duration">
                      <mat-header-cell *matHeaderCellDef>Duration</mat-header-cell>
                      <mat-cell *matCellDef="let element">{{ element.duration }}s</mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="actions">
                      <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
                      <mat-cell *matCellDef="let element">
                        <button mat-icon-button (click)="viewFullTranscript(element)">
                          <mat-icon>visibility</mat-icon>
                        </button>
                      </mat-cell>
                    </ng-container>
                    
                    <mat-header-row *matHeaderRowDef="['advertiser', 'transcript_preview', 'length', 'model', 'duration', 'actions']"></mat-header-row>
                    <mat-row *matRowDef="let row; columns: ['advertiser', 'transcript_preview', 'length', 'model', 'duration', 'actions']"></mat-row>
                  </mat-table>
                </div>

                <div *ngIf="!debugLoading && !transcriptionsData?.transcriptions?.length" class="debug-empty">
                  <mat-icon>text_fields</mat-icon>
                  <h4>No Transcriptions Found</h4>
                  <p>No video transcriptions are available in the current workflow data.</p>
                </div>
              </div>

              <!-- Test Transcription Tab -->
              <div *ngIf="debugTab === 'test'" class="debug-content">
                <div class="debug-section-header">
                  <h4>Test Video Transcription</h4>
                  <p>Enter a video URL to test the transcription service</p>
                </div>

                <div class="test-form">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Video URL</mat-label>
                    <input matInput [(ngModel)]="testVideoUrl" placeholder="https://example.com/video.mp4">
                    <mat-icon matSuffix>link</mat-icon>
                  </mat-form-field>
                  
                  <button mat-flat-button color="primary" 
                          (click)="testVideoTranscription()" 
                          [disabled]="!testVideoUrl || testingVideo"
                          class="test-btn">
                    <mat-icon *ngIf="!testingVideo">play_arrow</mat-icon>
                    <mat-spinner *ngIf="testingVideo" diameter="20"></mat-spinner>
                    {{ testingVideo ? 'Testing...' : 'Test Transcription' }}
                  </button>
                </div>

                <div *ngIf="testResult" class="test-result">
                  <div class="result-header">
                    <h5>Transcription Result</h5>
                    <span [class]="testResult.debug_info?.service_mode === 'mock' ? 'mock-badge' : 'real-badge'">
                      {{ testResult.debug_info?.service_mode }} mode
                    </span>
                  </div>
                  
                  <div class="result-content">
                    <div class="result-item">
                      <strong>Transcript:</strong>
                      <div class="transcript-text">{{ testResult.transcript_result?.transcript }}</div>
                    </div>
                    
                    <div class="result-meta">
                      <div class="meta-item">
                        <span>Duration:</span> {{ testResult.transcript_result?.duration }}s
                      </div>
                      <div class="meta-item">
                        <span>Language:</span> {{ testResult.transcript_result?.language }}
                      </div>
                      <div class="meta-item">
                        <span>Model:</span> {{ testResult.transcript_result?.model }}
                      </div>
                      <div class="meta-item">
                        <span>Processing Time:</span> {{ testResult.debug_info?.processing_time_ms }}ms
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="testError" class="test-error">
                  <mat-icon>error_outline</mat-icon>
                  <div>
                    <h5>Test Failed</h5>
                    <p>{{ testError }}</p>
                  </div>
                </div>
              </div>

              <!-- Video URLs Tab -->
              <div *ngIf="debugTab === 'videos'" class="debug-content">
                <div class="debug-section-header">
                  <h4>Video URLs from Scraped Ads</h4>
                  <button mat-stroked-button (click)="loadVideoAds()">
                    <mat-icon>refresh</mat-icon>
                    Refresh
                  </button>
                </div>

                <div *ngIf="debugLoading" class="debug-loading">
                  <mat-spinner diameter="30"></mat-spinner>
                  <span>Loading video ads...</span>
                </div>

                <div *ngIf="!debugLoading && videoAdsData" class="video-ads-summary">
                  <div class="summary-stats">
                    <div class="stat-item">
                      <span class="stat-number">{{ videoAdsData.summary?.total_video_ads || 0 }}</span>
                      <span class="stat-label">Video Ads</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-number">{{ videoAdsData.summary?.total_video_urls || 0 }}</span>
                      <span class="stat-label">Video URLs</span>
                    </div>
                    <div class="stat-item success">
                      <span class="stat-number">{{ videoAdsData.summary?.ads_with_transcripts || 0 }}</span>
                      <span class="stat-label">With Transcripts</span>
                    </div>
                    <div class="stat-item">
                      <span class="stat-number">{{ videoAdsData.summary?.unique_advertisers || 0 }}</span>
                      <span class="stat-label">Advertisers</span>
                    </div>
                  </div>
                </div>

                <div *ngIf="videoAdsData?.video_ads?.length" class="video-ads-table">
                  <mat-table [dataSource]="videoAdsData.video_ads" class="debug-table">
                    <ng-container matColumnDef="advertiser">
                      <mat-header-cell *matHeaderCellDef>Advertiser</mat-header-cell>
                      <mat-cell *matCellDef="let element">{{ element.advertiser }}</mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="ad_text">
                      <mat-header-cell *matHeaderCellDef>Ad Text</mat-header-cell>
                      <mat-cell *matCellDef="let element">
                        <span class="ad-text-preview">{{ element.ad_text }}...</span>
                      </mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="video_count">
                      <mat-header-cell *matHeaderCellDef>Videos</mat-header-cell>
                      <mat-cell *matCellDef="let element">{{ element.video_count }}</mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="has_transcripts">
                      <mat-header-cell *matHeaderCellDef>Transcribed</mat-header-cell>
                      <mat-cell *matCellDef="let element">
                        <mat-icon [class]="element.has_transcripts ? 'success-icon' : 'error-icon'">
                          {{ element.has_transcripts ? 'check_circle' : 'cancel' }}
                        </mat-icon>
                      </mat-cell>
                    </ng-container>
                    
                    <ng-container matColumnDef="actions">
                      <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
                      <mat-cell *matCellDef="let element">
                        <button mat-icon-button (click)="viewVideoUrls(element)">
                          <mat-icon>link</mat-icon>
                        </button>
                        <button mat-icon-button 
                                *ngIf="element.video_urls?.length > 0" 
                                (click)="testVideoUrl = element.video_urls[0]; debugTab = 'test'">
                          <mat-icon>play_arrow</mat-icon>
                        </button>
                      </mat-cell>
                    </ng-container>
                    
                    <mat-header-row *matHeaderRowDef="['advertiser', 'ad_text', 'video_count', 'has_transcripts', 'actions']"></mat-header-row>
                    <mat-row *matRowDef="let row; columns: ['advertiser', 'ad_text', 'video_count', 'has_transcripts', 'actions']"></mat-row>
                  </mat-table>
                </div>

                <div *ngIf="!debugLoading && !videoAdsData?.video_ads?.length" class="debug-empty">
                  <mat-icon>video_library</mat-icon>
                  <h4>No Video Ads Found</h4>
                  <p>No video advertisements are available in the current workflow data.</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- AI Chat Interface -->
          <div class="modern-ai-chat-section">
            <div class="chat-section-divider">
              <div class="divider-line"></div>
              <div class="divider-icon">
                <mat-icon>forum</mat-icon>
              </div>
              <div class="divider-line"></div>
            </div>
            
            <div class="chat-header">
              <div class="chat-icon">
                <mat-icon>chat</mat-icon>
              </div>
              <div class="chat-title">
                <h3>AI Chat Assistant</h3>
                <p>Ask follow-up questions about your competitor analysis results</p>
              </div>
              <div class="chat-status">
                <div class="status-indicator online"></div>
                <span>Online</span>
              </div>
            </div>
            
            <div class="chat-content">
              <!-- Integrate the AI Chat Component -->
              <app-ai-chat [analysisResults]="getAnalysisResultsForChat()"></app-ai-chat>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Analysis Meta Information -->
    <div class="section-container">
      <mat-card class="meta-info-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info</mat-icon>
            Analysis Information
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="meta-grid">
            <div class="meta-item">
              <span class="meta-label">Analysis ID:</span>
              <span class="meta-value">{{ datasetId }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Total Brands:</span>
              <span class="meta-value">{{ brandComparisons.length }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Total Ads Found:</span>
              <span class="meta-value">{{ totalAds }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Data Sources:</span>
              <span class="meta-value">{{ analysisResults.meta?.data_sources?.join(', ') || 'Multiple' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Analysis Duration:</span>
              <span class="meta-value">{{ analysisResults.meta?.analysis_duration || 'N/A' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

  </div>
</div>

<!-- Modern Video Modal -->
<div class="video-modal-overlay" *ngIf="showVideoModal" (click)="closeVideoModal()">
  <div class="video-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <h2>
        <mat-icon>movie</mat-icon>
        {{ modalTitle }}
      </h2>
      <button mat-icon-button (click)="closeVideoModal()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Video Summary Stats -->
    <div class="video-stats" *ngIf="!isFiltered">
      <div class="stat-card">
        <mat-icon>movie</mat-icon>
        <div class="stat-info">
          <span class="stat-number">{{ totalModalVideos }}</span>
          <span class="stat-label">Total Videos</span>
        </div>
      </div>
      
      <div class="stat-card" *ngFor="let brand of videoBreakdown">
        <mat-icon [style.color]="getBrandColor(brand.index)">business</mat-icon>
        <div class="stat-info">
          <span class="stat-number">{{ brand.count }}</span>
          <span class="stat-label">{{ brand.name }}</span>
        </div>
      </div>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">
      <div class="video-list">
        <div *ngFor="let video of displayedVideos; let i = index" class="video-item">
          <div class="video-info">
            <div class="video-header">
              <span class="video-number">{{ i + 1 }}</span>
              <div class="brand-tag" [style.background-color]="getBrandColorForName(video.brand)">
                {{ video.brand }}
              </div>
              <span class="video-date">{{ formatDate(video.dates?.start_date) }}</span>
            </div>
            
            <div class="video-content">
              <p class="video-text">{{ getVideoText(video) }}</p>
              
              <!-- Video URL Display -->
              <div class="video-url" *ngIf="getVideoUrl(video)">
                <mat-icon>link</mat-icon>
                <span class="url-label">Video URL:</span>
                <a [href]="getVideoUrl(video)" target="_blank" class="video-link">
                  {{ getVideoUrl(video) }}
                </a>
              </div>
              
              <!-- Video URL Not Available Message -->
              <div class="video-url-unavailable" *ngIf="!getVideoUrl(video) && video.creative?.has_video">
                <mat-icon>info</mat-icon>
                <span class="url-label">Video Status:</span>
                <span class="unavailable-message">Video content detected, but direct URL not available via Facebook Ad Library API</span>
              </div>
              
              <div class="video-actions">
                <a *ngIf="getVideoUrl(video)" 
                   [href]="getVideoUrl(video)" 
                   target="_blank" 
                   mat-raised-button 
                   color="primary" 
                   class="action-button">
                  <mat-icon>play_circle</mat-icon>
                  Watch Video
                </a>
                
                <a [href]="getFacebookUrl(video.id)" 
                   target="_blank" 
                   mat-stroked-button 
                   class="action-button">
                  <mat-icon>open_in_new</mat-icon>
                  View on Facebook
                </a>
                
                <button mat-raised-button 
                        color="accent" 
                        (click)="analyzeVideoWithAI(video)"
                        class="action-button">
                  <mat-icon>psychology</mat-icon>
                  Analyze with AI
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Load More Button -->
      <div class="load-more-section" *ngIf="hasMoreVideos">
        <button mat-raised-button color="accent" (click)="loadMoreVideos()">
          <mat-icon>expand_more</mat-icon>
          Load More Videos ({{ remainingVideos }} remaining)
        </button>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="modal-tips">
        <mat-icon>tips_and_updates</mat-icon>
        <span>Use AI Chat to analyze video patterns across all your competitor videos</span>
      </div>
      
      <div class="modal-actions">
        <button mat-stroked-button (click)="exportVideoData()">
          <mat-icon>download</mat-icon>
          Export Video List
        </button>
        <button mat-raised-button color="primary" (click)="closeVideoModal()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>