<div class="dashboard-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="loading-content">
      <div class="loading-animation">
        <mat-spinner diameter="60"></mat-spinner>
      </div>
      <h2>Analyzing Competitor Data</h2>
      <p>Processing Facebook ads data with AI-powered insights...</p>
      <div class="loading-steps">
        <div class="step active">
          <mat-icon>data_exploration</mat-icon>
          <span>Collecting Data</span>
        </div>
        <div class="step">
          <mat-icon>analytics</mat-icon>
          <span>Processing</span>
        </div>
        <div class="step">
          <mat-icon>insights</mat-icon>
          <span>Generating Insights</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage" class="error-state">
    <div class="error-content">
      <div class="error-icon">
        <mat-icon>error_outline</mat-icon>
      </div>
      <h2>Analysis Unavailable</h2>
      <p>{{ errorMessage }}</p>
      <div class="error-actions">
        <button mat-flat-button color="primary" routerLink="/competitor-analysis">
          <mat-icon>refresh</mat-icon>
          Start New Analysis
        </button>
      </div>
    </div>
  </div>

  <!-- Results Dashboard -->
  <div *ngIf="!isLoading && !errorMessage && analysisResults" class="dashboard-content">
    
    <!-- Modern Header -->
    <header class="dashboard-header">
      <div class="header-background">
        <div class="gradient-overlay"></div>
      </div>
      <div class="header-content">
        <div class="breadcrumb">
          <a routerLink="/competitor-analysis">
            <mat-icon>arrow_back</mat-icon>
            <span>Back to Analysis</span>
          </a>
        </div>
        <div class="title-section">
          <div class="competitor-badge">
            <mat-icon>business</mat-icon>
            <span>{{ brandComparisons[0]?.brand || 'Competitor' }}</span>
          </div>
          <h1>Intelligence Dashboard</h1>
          <p class="subtitle">Comprehensive analysis of {{ totalAds }} Facebook advertisements with AI-powered insights</p>
        </div>
        <div class="header-stats">
          <div class="stat-chip">
            <mat-icon>campaign</mat-icon>
            <span>{{ totalAds }} Ads</span>
          </div>
          <div class="stat-chip">
            <mat-icon>play_circle</mat-icon>
            <span>{{ totalVideoAds }} Videos</span>
          </div>
          <div class="stat-chip">
            <mat-icon>trending_up</mat-icon>
            <span>{{ formatPercentage(videoContentRate) }} Video Rate</span>
          </div>
        </div>
        <div class="header-actions">
          <button mat-stroked-button (click)="exportData()" class="action-btn">
            <mat-icon>download</mat-icon>
            <span>Export</span>
          </button>
          <button mat-flat-button color="primary" routerLink="/competitor-analysis" class="action-btn">
            <mat-icon>add</mat-icon>
            <span>New Analysis</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Modern Metrics Overview -->
    <section class="metrics-section">
      <div class="metrics-header">
        <h2>Performance Overview</h2>
        <p>Key insights from your competitor analysis</p>
      </div>
      <div class="metrics-grid">
        <div class="metric-card primary">
          <div class="metric-icon">
            <mat-icon>insights</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ totalAds }}</div>
            <div class="metric-label">Total Advertisements</div>
            <div class="metric-trend positive">
              <mat-icon>trending_up</mat-icon>
              <span>Active campaign</span>
            </div>
          </div>
        </div>

        <div class="metric-card secondary" (click)="showVideoAds()">
          <div class="metric-icon">
            <mat-icon>movie_creation</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">{{ totalVideoAds }}</div>
            <div class="metric-label">Video Content</div>
            <div class="metric-trend">
              <mat-icon>play_circle</mat-icon>
              <span>{{ formatPercentage(videoContentRate) }} of ads</span>
            </div>
          </div>
          <div class="metric-action">
            <mat-icon>open_in_new</mat-icon>
          </div>
        </div>

        <div class="metric-card accent">
          <div class="metric-icon">
            <mat-icon>psychology</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value">AI</div>
            <div class="metric-label">Analysis Ready</div>
            <div class="metric-trend">
              <mat-icon>smart_toy</mat-icon>
              <span>{{ totalVideoAds }} videos queued</span>
            </div>
          </div>
        </div>

        <div class="metric-card highlight">
          <div class="metric-icon">
            <mat-icon>business</mat-icon>
          </div>
          <div class="metric-content">
            <div class="metric-value competitor-name">{{ (brandComparisons[0]?.brand || 'Competitor').substring(0, 12) }}</div>
            <div class="metric-label">Target Competitor</div>
            <div class="metric-trend">
              <mat-icon>verified</mat-icon>
              <span>Analysis complete</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Competitor Intelligence Section -->
    <section class="intelligence-section">
      <div class="section-header">
        <h2>
          <mat-icon>insights</mat-icon>
          Competitive Intelligence
        </h2>
        <p>Deep dive into {{ brandComparisons[0]?.brand || 'competitor' }}'s advertising strategy</p>
      </div>
      
      <div class="intelligence-grid">
        <!-- Strategy Overview -->
        <div class="intelligence-card strategy-card">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>lightbulb</mat-icon>
            </div>
            <h3>Strategy Overview</h3>
          </div>
          <div class="card-content">
            <div class="strategy-stats">
              <div class="strategy-stat">
                <span class="stat-number">{{ brandComparisons[0]?.ad_frequency || 0 }}</span>
                <span class="stat-label">Total Campaigns</span>
              </div>
              <div class="strategy-stat">
                <span class="stat-number">{{ formatPercentage(videoContentRate) }}</span>
                <span class="stat-label">Video Focus</span>
              </div>
              <div class="strategy-stat">
                <span class="stat-number">{{ brandComparisons[0]?.metrics?.total_spend?.toFixed(0) || 0 }}</span>
                <span class="stat-label">Avg Text Length</span>
              </div>
            </div>
            <div class="strategy-insight">
              <mat-icon>info</mat-icon>
              <span>{{ brandComparisons[0]?.brand || 'Competitor' }} shows {{ videoContentRate > 30 ? 'heavy' : videoContentRate > 15 ? 'moderate' : 'light' }} video content focus</span>
            </div>
          </div>
        </div>

        <!-- Creative Distribution -->
        <div class="intelligence-card creative-card">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>palette</mat-icon>
            </div>
            <h3>Creative Mix</h3>
          </div>
          <div class="card-content">
            <div class="creative-breakdown">
              <div class="creative-type" (click)="showBrandVideos(brandComparisons[0]?.brand || 'Competitor')">
                <div class="type-icon video">
                  <mat-icon>play_circle</mat-icon>
                </div>
                <div class="type-info">
                  <span class="type-count">{{ brandComparisons[0]?.creative_types?.video || 0 }}</span>
                  <span class="type-label">Video Ads</span>
                </div>
                <mat-icon class="action-icon">arrow_forward</mat-icon>
              </div>
              <div class="creative-type">
                <div class="type-icon image">
                  <mat-icon>image</mat-icon>
                </div>
                <div class="type-info">
                  <span class="type-count">{{ brandComparisons[0]?.creative_types?.image || 0 }}</span>
                  <span class="type-label">Image Ads</span>
                </div>
              </div>
              <div class="creative-type">
                <div class="type-icon carousel">
                  <mat-icon>view_carousel</mat-icon>
                </div>
                <div class="type-info">
                  <span class="type-count">{{ brandComparisons[0]?.creative_types?.carousel || 0 }}</span>
                  <span class="type-label">Carousel Ads</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Market Position -->
        <div class="intelligence-card position-card">
          <div class="card-header">
            <div class="card-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <h3>Market Position</h3>
          </div>
          <div class="card-content">
            <div class="position-score">
              <div class="score-circle">
                <span class="score-value">{{ (brandComparisons[0]?.market_share || 0).toFixed(0) }}%</span>
              </div>
              <span class="score-label">Market Share</span>
            </div>
            <div class="position-insights">
              <div class="insight-item">
                <mat-icon>schedule</mat-icon>
                <span>Active campaign strategy</span>
              </div>
              <div class="insight-item">
                <mat-icon>trending_up</mat-icon>
                <span>{{ videoContentRate > 25 ? 'High' : 'Standard' }} video engagement</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Recent Ads Gallery -->
    <section class="ads-section">
      <div class="section-header">
        <h2>
          <mat-icon>history</mat-icon>
          Recent Advertisements
        </h2>
        <p>Latest ads from {{ brandComparisons[0]?.brand || 'competitor' }}'s campaign</p>
      </div>
      
      <div class="ads-gallery" *ngIf="topPerformingAds.length > 0">
        <div *ngFor="let ad of topPerformingAds; let i = index" 
             class="ad-showcase" 
             (click)="openAdDetails(ad)">
          <div class="ad-badge">
            <span class="ad-number">#{{ i + 1 }}</span>
            <div class="ad-type" [ngClass]="ad.creative.has_video ? 'video' : 'image'">
              <mat-icon>{{ ad.creative.has_video ? 'play_circle' : 'image' }}</mat-icon>
            </div>
          </div>
          
          <div class="ad-preview">
            <div class="advertiser-badge">
              <mat-icon>business</mat-icon>
              <span>{{ ad.advertiser.name }}</span>
              <mat-icon *ngIf="ad.advertiser.verified" class="verified">verified</mat-icon>
            </div>
            
            <div class="ad-content">
              <p class="ad-text">{{ getAdPreviewText(ad) }}</p>
            </div>
            
            <div class="ad-meta">
              <div class="meta-item">
                <mat-icon>calendar_today</mat-icon>
                <span>{{ ad.dates.start_date | date:'MMM d' }}</span>
              </div>
              <div class="meta-item">
                <mat-icon>text_fields</mat-icon>
                <span>{{ ad.creative.body?.length || 0 }} chars</span>
              </div>
              <div class="meta-item status" [ngClass]="ad.metadata.is_active ? 'active' : 'historical'">
                <mat-icon>{{ ad.metadata.is_active ? 'radio_button_checked' : 'history' }}</mat-icon>
                <span>{{ ad.metadata.is_active ? 'Active' : 'Historical' }}</span>
              </div>
            </div>
          </div>
          
          <div class="ad-actions">
            <button mat-icon-button class="action-btn" title="View Details">
              <mat-icon>open_in_new</mat-icon>
            </button>
          </div>
        </div>
      </div>
      
      <div *ngIf="topPerformingAds.length === 0" class="no-ads-state">
        <div class="no-ads-icon">
          <mat-icon>search_off</mat-icon>
        </div>
        <h3>No Recent Ads Found</h3>
        <p>No advertisement data is available for analysis</p>
      </div>
    </section>

    <!-- Brand Deep Dive -->
    <section class="brand-analysis-section" *ngFor="let brand of brandComparisons; let i = index">
      <div class="brand-analysis-card">
        <div class="brand-header">
          <div class="brand-identity">
            <div class="brand-avatar" [style.background]="getBrandColor(i)">
              <span class="brand-initial">{{ (brand.brand || 'C').charAt(0).toUpperCase() }}</span>
            </div>
            <div class="brand-info">
              <h3>{{ brand.brand }} Deep Dive</h3>
              <p>{{ brand.ad_frequency }} campaigns â€¢ {{ formatPercentage(brand.market_share) }} market presence</p>
            </div>
          </div>
          <div class="brand-score">
            <div class="score-ring">
              <span class="score-value">{{ (brand.market_share || 0).toFixed(0) }}</span>
            </div>
            <span class="score-label">Activity Score</span>
          </div>
        </div>
        
        <div class="brand-content">
          <div class="performance-grid">
            <div class="performance-metric video">
              <div class="metric-icon">
                <mat-icon>play_circle</mat-icon>
              </div>
              <div class="metric-data">
                <span class="metric-number">{{ formatPercentage(brand.metrics.total_impressions) }}</span>
                <span class="metric-label">Video Content Rate</span>
                <div class="metric-trend positive">
                  <mat-icon>trending_up</mat-icon>
                  <span>Strong video focus</span>
                </div>
              </div>
            </div>
            
            <div class="performance-metric text">
              <div class="metric-icon">
                <mat-icon>article</mat-icon>
              </div>
              <div class="metric-data">
                <span class="metric-number">{{ brand.metrics.total_spend.toFixed(0) }}</span>
                <span class="metric-label">Avg Text Length</span>
                <div class="metric-trend">
                  <mat-icon>text_fields</mat-icon>
                  <span>{{ brand.metrics.total_spend > 100 ? 'Detailed' : 'Concise' }}</span>
                </div>
              </div>
            </div>
            
            <div class="performance-metric content">
              <div class="metric-icon">
                <mat-icon>library_books</mat-icon>
              </div>
              <div class="metric-data">
                <span class="metric-number">{{ brand.metrics.average_cpm + brand.metrics.average_ctr }}</span>
                <span class="metric-label">Total Content</span>
                <div class="metric-trend">
                  <mat-icon>inventory</mat-icon>
                  <span>{{ brand.metrics.average_cpm > 10 ? 'High' : 'Moderate' }} volume</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="creative-breakdown">
            <h4>Creative Portfolio</h4>
            <div class="portfolio-items">
              <div class="portfolio-item" (click)="showBrandVideos(brand.brand || 'Competitor')">
                <div class="item-icon video">
                  <mat-icon>movie_creation</mat-icon>
                </div>
                <div class="item-details">
                  <span class="item-count">{{ brand.creative_types.video }}</span>
                  <span class="item-label">Video Campaigns</span>
                </div>
                <mat-icon class="item-action">launch</mat-icon>
              </div>
              
              <div class="portfolio-item">
                <div class="item-icon image">
                  <mat-icon>photo_library</mat-icon>
                </div>
                <div class="item-details">
                  <span class="item-count">{{ brand.creative_types.image }}</span>
                  <span class="item-label">Image Campaigns</span>
                </div>
              </div>
              
              <div class="portfolio-item">
                <div class="item-icon carousel">
                  <mat-icon>view_carousel</mat-icon>
                </div>
                <div class="item-details">
                  <span class="item-count">{{ brand.creative_types.carousel }}</span>
                  <span class="item-label">Carousel Campaigns</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AI Analysis & Chat Section -->
    <section class="ai-analysis-section">
      <div class="ai-analysis-container">
        <!-- Modern Header -->
        <div class="ai-header">
          <div class="header-background">
            <div class="ai-gradient-overlay"></div>
          </div>
          <div class="header-content">
            <div class="ai-icon-badge">
              <mat-icon>psychology</mat-icon>
            </div>
            <div class="header-text">
              <h2>AI-Powered Analysis</h2>
              <p>Get intelligent insights and chat about your competitor analysis with advanced AI</p>
            </div>
            <div class="ai-status-indicator">
              <div class="status-dot active"></div>
              <span>AI Ready</span>
            </div>
          </div>
        </div>
        
        <!-- Modern Content Area -->
        <div class="ai-content-area">
          <!-- Analysis Mode Toggle -->
          <div class="modern-mode-toggle">
            <div class="toggle-header">
              <h3>Choose Analysis Type</h3>
              <p>Select the type of AI analysis you want to perform</p>
            </div>
            <div class="toggle-cards">
              <div class="mode-card" 
                   [class.active]="analysisMode === 'general'"
                   (click)="switchAnalysisMode('general')">
                <div class="card-icon general">
                  <mat-icon>analytics</mat-icon>
                </div>
                <div class="card-content">
                  <h4>General Analysis</h4>
                  <p>Custom AI insights and analysis</p>
                </div>
                <div class="card-indicator" *ngIf="analysisMode === 'general'">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
              
              <div class="mode-card" 
                   [class.active]="analysisMode === 'video'"
                   (click)="switchAnalysisMode('video')">
                <div class="card-icon video">
                  <mat-icon>movie_creation</mat-icon>
                </div>
                <div class="card-content">
                  <h4>Bulk Video Analysis</h4>
                  <p>Analyze all {{ totalVideoAds }} videos with AI</p>
                </div>
                <div class="card-indicator" *ngIf="analysisMode === 'video'">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- General Analysis Section -->
          <div *ngIf="analysisMode === 'general'" class="modern-analysis-section">
            <div class="analysis-card">
              <div class="analysis-card-header">
                <div class="analysis-icon">
                  <mat-icon>psychology</mat-icon>
                </div>
                <div class="analysis-title">
                  <h3>Custom AI Analysis</h3>
                  <p>Ask AI to analyze your competitor data with intelligent insights</p>
                </div>
              </div>
              
              <div class="analysis-card-content">
                <div class="prompt-input-section">
                  <label class="input-label">
                    <mat-icon>edit</mat-icon>
                    Your Analysis Prompt
                  </label>
                  <div class="modern-textarea-container">
                    <textarea 
                      class="modern-textarea"
                      [(ngModel)]="customPrompt" 
                      rows="4"
                      placeholder="e.g., 'Analyze video content strategies across competitors' or 'What messaging themes are most common?'"
                    ></textarea>
                    <div class="textarea-actions">
                      <button class="quick-prompts-btn" (click)="showQuickPrompts = !showQuickPrompts">
                        <mat-icon>lightbulb</mat-icon>
                        <span>Quick Ideas</span>
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="analysis-actions">
                  <button 
                    class="primary-analysis-btn"
                    (click)="runCustomAnalysis()"
                    [disabled]="!customPrompt.trim() || isAnalyzing"
                  >
                    <div class="btn-content">
                      <mat-icon *ngIf="!isAnalyzing">psychology</mat-icon>
                      <mat-spinner *ngIf="isAnalyzing" diameter="20"></mat-spinner>
                      <span>{{ isAnalyzing ? 'Analyzing...' : 'Run AI Analysis' }}</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>

            <!-- Quick Prompt Suggestions -->
            <div *ngIf="showQuickPrompts" class="modern-quick-prompts">
              <div class="prompts-header">
                <mat-icon>auto_awesome</mat-icon>
                <h4>AI Prompt Suggestions</h4>
              </div>
              <div class="prompts-grid">
                <button 
                  *ngFor="let prompt of quickPrompts" 
                  class="prompt-suggestion-card"
                  (click)="useQuickPrompt(prompt)"
                >
                  <mat-icon>spark</mat-icon>
                  <span>{{ prompt }}</span>
                </button>
              </div>
            </div>

            <!-- Analysis Results -->
            <div *ngIf="customAnalysisResult" class="modern-analysis-results">
              <div class="results-header">
                <div class="results-icon">
                  <mat-icon>insights</mat-icon>
                </div>
                <div class="results-title">
                  <h3>AI Analysis Results</h3>
                  <div class="ai-provider-badge">
                    <mat-icon>smart_toy</mat-icon>
                    <span>{{ customAnalysisResult.metadata?.ai_provider || 'AI' }}</span>
                  </div>
                </div>
              </div>
              <div class="results-content">
                <div class="analysis-output" [innerHTML]="formatAnalysisResult(customAnalysisResult.analysis)"></div>
              </div>
            </div>
          </div>

          <!-- Bulk Video Analysis Section -->
          <div *ngIf="analysisMode === 'video'" class="modern-video-analysis-section">
            <div class="video-analysis-card">
              <div class="video-analysis-header">
                <div class="video-icon-badge">
                  <mat-icon>movie_creation</mat-icon>
                </div>
                <div class="video-title">
                  <h3>Bulk Video Analysis</h3>
                  <p>Analyze ALL competitor videos ({{ totalVideoAds }} videos) with AI-powered insights</p>
                </div>
                <div class="video-count-badge">
                  <span class="count">{{ totalVideoAds }}</span>
                  <span class="label">Videos</span>
                </div>
              </div>
              
              <!-- Video Analysis Options -->
              <div class="modern-analysis-options">
                <h4>Analysis Options</h4>
                <div class="options-grid">
                  <div class="option-card" [class.enabled]="includeTranscripts">
                    <label class="option-label">
                      <input type="checkbox" [(ngModel)]="includeTranscripts" class="hidden-checkbox">
                      <div class="option-content">
                        <div class="option-icon">
                          <mat-icon>subtitles</mat-icon>
                        </div>
                        <div class="option-text">
                          <span class="option-title">Video Transcripts</span>
                          <span class="option-desc">OpenAI Whisper powered</span>
                        </div>
                        <div class="option-toggle">
                          <div class="toggle-indicator"></div>
                        </div>
                      </div>
                    </label>
                  </div>
                  
                  <div class="option-card disabled">
                    <div class="option-content">
                      <div class="option-icon">
                        <mat-icon>visibility</mat-icon>
                      </div>
                      <div class="option-text">
                        <span class="option-title">Visual Analysis</span>
                        <span class="option-desc">Coming Soon</span>
                      </div>
                      <div class="coming-soon-badge">
                        <mat-icon>schedule</mat-icon>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Video Analysis Templates -->
              <div class="modern-templates-section">
                <div class="templates-header">
                  <div class="templates-title">
                    <mat-icon>auto_awesome</mat-icon>
                    <h4>Analysis Templates</h4>
                  </div>
                  <button class="templates-toggle-btn" (click)="showVideoTemplates = !showVideoTemplates">
                    <span>{{ videoAnalysisTemplates.length }} Professional Templates</span>
                    <mat-icon>{{ showVideoTemplates ? 'expand_less' : 'expand_more' }}</mat-icon>
                  </button>
                </div>

                <div *ngIf="showVideoTemplates" class="modern-templates-grid">
                  <div *ngFor="let template of videoAnalysisTemplates" 
                       class="modern-template-card"
                       [class.selected]="selectedVideoTemplate === template.id"
                       (click)="useVideoTemplate(template.id)">
                    <div class="template-content">
                      <div class="template-icon">
                        <mat-icon>description</mat-icon>
                      </div>
                      <div class="template-info">
                        <h5>{{ template.name }}</h5>
                        <p>{{ template.description }}</p>
                      </div>
                      <div class="template-selector" *ngIf="selectedVideoTemplate === template.id">
                        <mat-icon>check_circle</mat-icon>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Custom Prompt Section -->
              <div class="video-prompt-section">
                <label class="prompt-label">
                  <mat-icon>edit</mat-icon>
                  Custom Video Analysis Prompt
                </label>
                <div class="video-textarea-container">
                  <textarea 
                    class="video-textarea"
                    [(ngModel)]="customPrompt" 
                    rows="5"
                    placeholder="Describe what insights you want from the competitor's video content..."
                  ></textarea>
                  <div class="textarea-hint">
                    <mat-icon>lightbulb</mat-icon>
                    <span>Tip: Use templates above or create your own analysis prompt for {{ totalVideoAds }} videos</span>
                  </div>
                </div>
              </div>
              
              <!-- Analysis Actions -->
              <div class="video-analysis-actions">
                <button 
                  class="video-analyze-btn"
                  (click)="startBulkVideoAnalysis()"
                  [disabled]="!customPrompt.trim() || isBulkAnalyzing || totalVideoAds === 0">
                  <div class="btn-content">
                    <mat-icon *ngIf="!isBulkAnalyzing">smart_toy</mat-icon>
                    <mat-spinner *ngIf="isBulkAnalyzing" diameter="22"></mat-spinner>
                    <span>{{ isBulkAnalyzing ? 'Analyzing Videos...' : 'Analyze ' + totalVideoAds + ' Videos' }}</span>
                  </div>
                </button>
                
                <button 
                  *ngIf="isBulkAnalyzing"
                  class="cancel-btn"
                  (click)="cancelBulkAnalysis()">
                  <mat-icon>stop</mat-icon>
                  <span>Cancel Analysis</span>
                </button>
              </div>
            </div>

            <!-- Progress Tracking -->
            <div *ngIf="bulkAnalysisProgress" class="analysis-progress">
              <div class="progress-header">
                <h5>
                  <mat-icon>hourglass_empty</mat-icon>
                  {{ bulkAnalysisProgress.message }}
                </h5>
                <span class="progress-stats">{{ bulkAnalysisProgress.current || 0 }}/{{ bulkAnalysisProgress.total || 0 }}</span>
              </div>
              
              <mat-progress-bar 
                mode="determinate" 
                [value]="bulkAnalysisProgress.percentage || 0">
              </mat-progress-bar>
              
              <div class="progress-stages">
                <div class="stage" [class.active]="bulkAnalysisProgress.stage === 'initializing'">
                  <mat-icon>start</mat-icon>
                  <span>Initializing</span>
                </div>
                <div class="stage" [class.active]="bulkAnalysisProgress.stage === 'transcribing'">
                  <mat-icon>subtitles</mat-icon>
                  <span>Transcribing</span>
                </div>
                <div class="stage" [class.active]="bulkAnalysisProgress.stage === 'analyzing'">
                  <mat-icon>psychology</mat-icon>
                  <span>AI Analysis</span>
                </div>
                <div class="stage" [class.active]="bulkAnalysisProgress.stage === 'completed'">
                  <mat-icon>check_circle</mat-icon>
                  <span>Complete</span>
                </div>
              </div>
            </div>

            <!-- Bulk Analysis Results -->
            <div *ngIf="bulkAnalysisResult" class="bulk-analysis-results">
              <mat-divider></mat-divider>
              <div class="results-header">
                <h5>
                  <mat-icon>assessment</mat-icon>
                  Bulk Video Analysis Report
                  <span class="video-count">({{ bulkAnalysisProgress?.total || 0 }} videos analyzed)</span>
                </h5>
                <button mat-stroked-button (click)="downloadBulkAnalysisReport()">
                  <mat-icon>download</mat-icon>
                  Download Report
                </button>
              </div>
              
              <div class="bulk-analysis-content">
                <div class="analysis-summary" *ngIf="bulkAnalysisResult.summary">
                  <h6>Executive Summary</h6>
                  <div [innerHTML]="formatAnalysisResult(bulkAnalysisResult.summary)"></div>
                </div>
                
                <div class="detailed-analysis" *ngIf="bulkAnalysisResult.analysis">
                  <h6>Detailed Analysis</h6>
                  <div [innerHTML]="formatAnalysisResult(bulkAnalysisResult.analysis)"></div>
                </div>
                
                <div class="recommendations" *ngIf="bulkAnalysisResult.recommendations">
                  <h6>Strategic Recommendations</h6>
                  <div [innerHTML]="formatAnalysisResult(bulkAnalysisResult.recommendations)"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- AI Chat Interface -->
          <div class="modern-ai-chat-section">
            <div class="chat-section-divider">
              <div class="divider-line"></div>
              <div class="divider-icon">
                <mat-icon>forum</mat-icon>
              </div>
              <div class="divider-line"></div>
            </div>
            
            <div class="chat-header">
              <div class="chat-icon">
                <mat-icon>chat</mat-icon>
              </div>
              <div class="chat-title">
                <h3>AI Chat Assistant</h3>
                <p>Ask follow-up questions about your competitor analysis results</p>
              </div>
              <div class="chat-status">
                <div class="status-indicator online"></div>
                <span>Online</span>
              </div>
            </div>
            
            <div class="chat-content">
              <!-- Integrate the AI Chat Component -->
              <app-ai-chat [analysisResults]="getAnalysisResultsForChat()"></app-ai-chat>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Analysis Meta Information -->
    <div class="section-container">
      <mat-card class="meta-info-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info</mat-icon>
            Analysis Information
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="meta-grid">
            <div class="meta-item">
              <span class="meta-label">Analysis ID:</span>
              <span class="meta-value">{{ datasetId }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Total Brands:</span>
              <span class="meta-value">{{ brandComparisons.length }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Total Ads Found:</span>
              <span class="meta-value">{{ totalAds }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Data Sources:</span>
              <span class="meta-value">{{ analysisResults.meta?.data_sources?.join(', ') || 'Multiple' }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Analysis Duration:</span>
              <span class="meta-value">{{ analysisResults.meta?.analysis_duration || 'N/A' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

  </div>
</div>

<!-- Modern Video Modal -->
<div class="video-modal-overlay" *ngIf="showVideoModal" (click)="closeVideoModal()">
  <div class="video-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <h2>
        <mat-icon>movie</mat-icon>
        {{ modalTitle }}
      </h2>
      <button mat-icon-button (click)="closeVideoModal()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Video Summary Stats -->
    <div class="video-stats" *ngIf="!isFiltered">
      <div class="stat-card">
        <mat-icon>movie</mat-icon>
        <div class="stat-info">
          <span class="stat-number">{{ totalModalVideos }}</span>
          <span class="stat-label">Total Videos</span>
        </div>
      </div>
      
      <div class="stat-card" *ngFor="let brand of videoBreakdown">
        <mat-icon [style.color]="getBrandColor(brand.index)">business</mat-icon>
        <div class="stat-info">
          <span class="stat-number">{{ brand.count }}</span>
          <span class="stat-label">{{ brand.name }}</span>
        </div>
      </div>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">
      <div class="video-list">
        <div *ngFor="let video of displayedVideos; let i = index" class="video-item">
          <div class="video-info">
            <div class="video-header">
              <span class="video-number">{{ i + 1 }}</span>
              <div class="brand-tag" [style.background-color]="getBrandColorForName(video.brand)">
                {{ video.brand }}
              </div>
              <span class="video-date">{{ formatDate(video.dates?.start_date) }}</span>
            </div>
            
            <div class="video-content">
              <p class="video-text">{{ getVideoText(video) }}</p>
              
              <!-- Video URL Display -->
              <div class="video-url" *ngIf="getVideoUrl(video)">
                <mat-icon>link</mat-icon>
                <span class="url-label">Video URL:</span>
                <a [href]="getVideoUrl(video)" target="_blank" class="video-link">
                  {{ getVideoUrl(video) }}
                </a>
              </div>
              
              <!-- Video URL Not Available Message -->
              <div class="video-url-unavailable" *ngIf="!getVideoUrl(video) && video.creative?.has_video">
                <mat-icon>info</mat-icon>
                <span class="url-label">Video Status:</span>
                <span class="unavailable-message">Video content detected, but direct URL not available via Facebook Ad Library API</span>
              </div>
              
              <div class="video-actions">
                <a *ngIf="getVideoUrl(video)" 
                   [href]="getVideoUrl(video)" 
                   target="_blank" 
                   mat-raised-button 
                   color="primary" 
                   class="action-button">
                  <mat-icon>play_circle</mat-icon>
                  Watch Video
                </a>
                
                <a [href]="getFacebookUrl(video.id)" 
                   target="_blank" 
                   mat-stroked-button 
                   class="action-button">
                  <mat-icon>open_in_new</mat-icon>
                  View on Facebook
                </a>
                
                <button mat-raised-button 
                        color="accent" 
                        (click)="analyzeVideoWithAI(video)"
                        class="action-button">
                  <mat-icon>psychology</mat-icon>
                  Analyze with AI
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Load More Button -->
      <div class="load-more-section" *ngIf="hasMoreVideos">
        <button mat-raised-button color="accent" (click)="loadMoreVideos()">
          <mat-icon>expand_more</mat-icon>
          Load More Videos ({{ remainingVideos }} remaining)
        </button>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="modal-tips">
        <mat-icon>tips_and_updates</mat-icon>
        <span>Use AI Chat to analyze video patterns across all your competitor videos</span>
      </div>
      
      <div class="modal-actions">
        <button mat-stroked-button (click)="exportVideoData()">
          <mat-icon>download</mat-icon>
          Export Video List
        </button>
        <button mat-raised-button color="primary" (click)="closeVideoModal()">
          Close
        </button>
      </div>
    </div>
  </div>
</div>